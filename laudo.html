<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Laudo</title>

<style>
  :root{
    --blue:#336699;
    --panel:#eef2f7;
  }

  body{
    margin:0;
    padding:18px;
    background:#f4f4f4;
    font-family: Arial, sans-serif;
  }

  /* ===== CONTROLES ===== */
  .controles{
    position: static;
    margin-top: 18px;
    background:#fff;
    border:1px solid #000;
    padding:14px;
    width: 100%;
    max-width: 420px;
    margin-left:auto;
    margin-right:auto;
    border-radius: 10px;
  }
  .btn{
    width:100%;
    padding:12px;
    font-weight:900;
    cursor:pointer;
    border:none;
    border-radius:6px;
  }
  .btn-print{ background:#28a745;color:#fff; }
  .btn-word{ margin-top:10px;background:#1f6feb;color:#fff; }
  .btn-clear{ margin-top:10px;background:#eee; }

  /* ===== FOLHA (TELA) ===== */
  .folha{
    width: 210mm;
    min-height: 297mm;
    margin:auto;
    background:#fff;
    box-shadow: 0 0 10px rgba(0,0,0,.12);
    box-sizing:border-box;
    padding:14mm 18mm;
    position:relative;
  }

  /* ===== TELA (FORMULÁRIO) ===== */
  .titulo-laudo{
    text-align:center;
    font-weight:800;
    font-size:12pt;
    margin: 8px 0 14px;
    text-transform:uppercase;
    font-family:"Arial Narrow", Arial, sans-serif;
  }

  .painel{
    background:var(--panel);
    border: 2px solid #7aa4c7;
    border-radius:6px;
    padding:14px 14px 8px;
  }

  .sec{
    border-top: 2px solid #b5cbe0;
    padding-top:10px;
    margin-top:10px;
  }
  .sec:first-child{ border-top:none; padding-top:0; margin-top:0; }

  .sec-title{
    color:var(--blue);
    font-weight:900;
    font-size:10pt;
    text-transform:uppercase;
    margin:0 0 8px;
    font-family:"Arial Narrow", Arial, sans-serif;
  }

  .linha{
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    margin-bottom:10px;
    align-items:center;
    font-family:"Arial Narrow", Arial, sans-serif;
    font-size:11pt;
  }

  .lbl{
    font-weight:900;
    text-transform:uppercase;
    min-width:160px;
  }

  .op-row{
    display:flex;
    gap:16px;
    flex-wrap:wrap;
  }
  .op-row label,
  .op-col label{
    display:flex;
    gap:8px;
    cursor:pointer;
    font-weight:400;
    align-items:flex-start;
  }

  .op-col{
    display:flex;
    flex-direction:column;
    gap:8px;
    margin-top:8px;
  }
  .grupo{
    margin-left:18px;
    display:flex;
    flex-direction:column;
    gap:8px;
    margin-top:6px;
  }

  /* ===== OBSERVAÇÃO (TELA) ===== */
  .obs-wrap{
    margin-top:12px;
    background:#e9eff7;
    border: 2px dashed #9cb6cf;
    border-radius:12px;
    padding:12px;
  }
  .obs-title{
    font-weight:900;
    font-family:"Arial Narrow", Arial, sans-serif;
    font-size:12pt;
    margin-bottom:8px;
  }
  #obs_texto{
    width:100%;
    min-height:110px;
    resize:vertical;
    padding:10px;
    border-radius:10px;
    border:1px solid #b6c7d8;
    font-family:"Arial Narrow", Arial, sans-serif;
    font-size:11pt;
    box-sizing:border-box;
  }

  /* ===== PRINT ===== */
  .print-only{ display:none; }

  @media print{
    body{ background:#fff; padding:0; margin:0; }
    .controles{ display:none !important; }
    .no-print{ display:none !important; }
    .print-only{ display:block !important; }

    /* ✅ Fundo timbrado fixo */
    .print-bg{
      position:fixed;
      inset:0;
      width:100%;
      height:100%;
      z-index:0;
      pointer-events:none;
    }
    .print-bg img{
      width:100%;
      height:100%;
      object-fit:cover;
    }

    /* ✅ Conteúdo por cima do timbre
       ✅ DESCE mais para ficar abaixo do logo SESC */
    .print-page{
      position:relative;
      z-index:2;
      margin: 0;

      /* ✅ descer conteúdo (antes 28mm/40mm, agora 44mm) */
      padding: 50mm 18mm 22mm 18mm;

      box-sizing:border-box;
      font-family:"Arial Narrow", Arial, sans-serif;
    }

    .folha{ box-shadow:none; width:auto; min-height:auto; padding:0; }

    @page{ size:A4; margin:0; }
  }

  /* ===== PRINT LAYOUT (PROFISSIONAL) ===== */
  .cab-paciente{
    border-top: 3px solid #00a651;
    border-bottom: 3px solid #00a651;
    padding: 10px 0;
    margin: 0 0 14px;
  }
  .cab-row1{ display:flex; justify-content:space-between; gap:20px; }
  .cab-left{ flex:1; }
  .cab-right{ min-width:220px; text-align:right; }

  /* ✅ maior */
  .cab-lbl2{
    font-size:13pt;
    font-weight:700;
    text-transform:uppercase;
    font-family:"Arial Narrow", Arial, sans-serif;
  }

  /* ✅ maior */
  .cab-nome, .cab-exame{
    font-size:12.6pt;
    font-weight:700;
    text-transform:uppercase;
    font-family:"Arial Narrow", Arial, sans-serif;
    line-height:1.2;
  }

  /* ✅ maior */
  .cab-row2{
    margin-top:10px;
    display:grid;
    grid-template-columns: 1.2fr 0.8fr;
    gap: 6px 40px;
    font-family:"Helvetica, Arial Narrow";
    font-size:10pt;
    text-transform:uppercase;
    font-weight:400;
  }

  /* ✅ maior */
  .linha-identificacao{
    font-family:"Arial Narrow", Arial, sans-serif;
    font-size:11.5pt;
    text-transform:uppercase;
    margin-bottom:4px;
    display:flex;
    gap:6px;
    align-items:baseline;
    white-space:nowrap;
  }

  /* ✅ maior */
  .secao-print{
    margin-bottom:12px;
    line-height:1.55;
    font-family:"Arial Narrow", sans-serif;
    font-size:11.5pt;
    text-align:justify;
  }

  .tit-negrito{ font-weight:800; text-transform:uppercase; }
  .tit-normal-caps{ font-weight:400; text-transform:uppercase; }
  .concl-resposta-bloco{ white-space:pre-line; font-weight:400; display:block; margin-top:2px; }

  #obs_print_wrap{ display:none; }

  .rodape-prof{
    margin-top:18px;
    text-align:center;
    font-family:"Arial Narrow", Arial, sans-serif;
    font-size:11.5pt;
  }
</style>
</head>

<body>

<div class="folha">

  <!-- =========================
       ✅ TELA: FORMULÁRIO
       ========================= -->
  <div class="no-print">
    <div class="titulo-laudo">LAUDO DO EXAME CITOPATOLÓGICO DO COLO DO ÚTERO</div>

    <div class="painel">
      <!-- 1 -->
      <div class="sec">
        <div class="sec-title">1. Avaliação Pré Analítica</div>

        <div class="linha">
          <div class="lbl">Adequabilidade:</div>
          <div class="op-row">
            <label><input type="radio" name="adeq" value="Satisfatória" onchange="atualizar()"> Satisfatória</label>
            <label><input type="radio" name="adeq" value="Insatisfatória" onchange="atualizar()"> Insatisfatória</label>
          </div>
        </div>

        <div class="linha">
          <div class="lbl">Epitélios:</div>
          <div class="op-row">
            <label><input type="checkbox" class="epi" value="ESCAMOSO" onchange="atualizar()"> Escamoso</label>
            <label><input type="checkbox" class="epi" value="GLANDULAR" onchange="atualizar()"> Glandular</label>
            <label><input type="checkbox" class="epi" value="METAPLÁSICO" onchange="atualizar()"> Metaplásico</label>
          </div>
        </div>

        <div class="linha">
          <div class="lbl">Zona de Transformação:</div>
          <div class="op-row">
            <label><input type="radio" name="zona" id="zona_sim" value="Sim" onchange="atualizar()"> Sim</label>
            <label><input type="radio" name="zona" id="zona_nao" value="Não" onchange="atualizar()"> Não</label>
          </div>
        </div>
      </div>

      <!-- 2 -->
      <div class="sec">
        <div class="sec-title">2. Diagnóstico Descritivo</div>

        <div class="op-col">
          <label><input type="checkbox" id="chk_norm" onchange="atualizar()"> DENTRO DOS LIMITES DA NORMALIDADE NO MATERIAL EXAMINADO</label>
        </div>

        <div class="linha" style="margin-top:10px;">
          <div class="lbl">ALTERAÇÕES CELULARES BENIGNAS:</div>
        </div>
        <div class="grupo">
          <label><input type="checkbox" class="alt" value="Inflamação" onchange="atualizar()"> Inflamação</label>
          <label><input type="checkbox" class="alt" value="Metaplasia escamosa imatura" onchange="atualizar()"> Metaplasia escamosa imatura</label>
          <label><input type="checkbox" class="alt" value="Reparação" onchange="atualizar()"> Reparação</label>
          <label><input type="checkbox" class="alt" value="Atrofia com inflamação" onchange="atualizar()"> Atrofia com inflamação</label>
          <label><input type="checkbox" class="alt" value="Radiação" onchange="atualizar()"> Radiação</label>
        </div>
      </div>

      <!-- 3 -->
      <div class="sec">
        <div class="sec-title">3. Microbiologia</div>
        <div class="grupo" style="margin-left:0;">
          <label><input type="checkbox" class="micro" value="Lactobacillus sp" onchange="atualizar()"> Lactobacillus sp</label>
          <label><input type="checkbox" class="micro" value="Cocos" onchange="atualizar()"> Cocos</label>
          <label><input type="checkbox" class="micro" value="Sugestivo de Chlamydia sp" onchange="atualizar()"> Sugestivo de Chlamydia sp</label>
          <label><input type="checkbox" class="micro" value="Actinomyces sp" onchange="atualizar()"> Actinomyces sp</label>
          <label><input type="checkbox" class="micro" value="Candida sp" onchange="atualizar()"> Candida sp</label>
          <label><input type="checkbox" class="micro" value="Trichomonas vaginalis" onchange="atualizar()"> Trichomonas vaginalis</label>
          <label><input type="checkbox" class="micro" data-full="Bacilos supracitoplasmáticos (sugestivos de Gardnerella/Mobiluncus)" value="Gardnerella/Mobiluncus" onchange="atualizar()"> Gardnerella/Mobiluncus</label>
          <label><input type="checkbox" class="micro" data-full="Efeito citopático compatível com vírus do grupo Herpes" value="Vírus Herpes" onchange="atualizar()"> Vírus Herpes</label>
        </div>
      </div>

      <!-- 4 -->
      <div class="sec">
        <div class="sec-title">4. Conclusão Técnica</div>

        <div class="op-col">
          <label><input type="radio" name="c" data-tit="CONCLUSÃO" data-full="NEGATIVO PARA MALIGNIDADE." value="NEGATIVO" onchange="atualizar()"> NEGATIVO PARA MALIGNIDADE.</label>
        </div>

        <div class="linha" style="margin-top:10px;">
          <div class="lbl">CÉLULAS ATÍPICAS DE SIGNIFICADO INDETERMINADO:</div>
        </div>
        <div class="grupo">
          <label><input type="radio" name="c" data-tit="CÉLULAS ATÍPICAS DE SIGNIFICADO INDETERMINADO" data-full="Escamosas: possivelmente não neoplásicas (ASC-US)" value="ASC-US" onchange="atualizar()"> ESCAMOSAS (ASC-US)</label>
          <label><input type="radio" name="c" data-tit="CÉLULAS ATÍPICAS DE SIGNIFICADO INDETERMINADO" data-full="Escamosas: não se pode afastar lesão intra-epitelial de alto grau (ASC-H)" value="ASC-H" onchange="atualizar()"> ESCAMOSAS (ASC-H)</label>
          <label><input type="radio" name="c" data-tit="CÉLULAS ATÍPICAS DE SIGNIFICADO INDETERMINADO" data-full="Glandulares: possivelmente não neoplásicas" value="GLANDULARES: Possivelmente não neoplásicas" onchange="atualizar()"> GLANDULARES: Possivelmente não neoplásicas</label>
          <label><input type="radio" name="c" data-tit="CÉLULAS ATÍPICAS DE SIGNIFICADO INDETERMINADO" data-full="Glandulares: não se pode afastar lesão de alto grau" value="GLANDULARES: Não se pode afastar alto grau" onchange="atualizar()"> GLANDULARES: Não se pode afastar alto grau</label>
        </div>

        <div class="linha" style="margin-top:10px;">
          <div class="lbl">ATIPIAS EM CÉLULAS ESCAMOSAS:</div>
        </div>
        <div class="grupo">
          <label><input type="radio" name="c" data-tit="ATIPIAS EM CÉLULAS ESCAMOSAS" data-full="Lesão intra-epitelial de baixo grau (compreendendo efeito citopático pelo vírus HPV e neoplasia intra-epitelial cervical grau I - NIC I)" value="NIC I" onchange="atualizar()"> BAIXO GRAU (HPV / NIC I)</label>
          <label><input type="radio" name="c" data-tit="ATIPIAS EM CÉLULAS ESCAMOSAS" data-full="Lesão intra-epitelial de alto grau (NIC II e III)" value="NIC II / III" onchange="atualizar()"> ALTO GRAU (NIC II / III)</label>
          <label><input type="radio" name="c" data-tit="ATIPIAS EM CÉLULAS ESCAMOSAS" data-full="Carcinoma epidermóide invasor" value="Carcinoma" onchange="atualizar()"> Carcinoma epidermóide invasor</label>
        </div>

        <div class="linha" style="margin-top:10px;">
          <div class="lbl">ATIPIAS EM CÉLULAS GLANDULARES:</div>
        </div>
        <div class="grupo">
          <label><input type="radio" name="c" data-tit="ATIPIAS EM CÉLULAS GLANDULARES" data-full="Adenocarcinoma 'in situ'" value="Adenocarcinoma 'in situ'" onchange="atualizar()"> Adenocarcinoma "in situ"</label>
          <label><input type="radio" name="c" data-tit="ATIPIAS EM CÉLULAS GLANDULARES" data-full="Adenocarcinoma invasor, cervical" value="Adenocarcinoma cervical" onchange="atualizar()"> Adenocarcinoma invasor, cervical</label>
          <label><input type="radio" name="c" data-tit="ATIPIAS EM CÉLULAS GLANDULARES" data-full="Adenocarcinoma invasor, endometrial" value="Adenocarcinoma endometrial" onchange="atualizar()"> Adenocarcinoma invasor, endometrial</label>
          <label><input type="radio" name="c" data-tit="ATIPIAS EM CÉLULAS GLANDULARES" data-full="Adenocarcinoma invasor, SOE" value="Adenocarcinoma SOE" onchange="atualizar()"> Adenocarcinoma invasor, SOE</label>
        </div>
      </div>
    </div>

    <div class="obs-wrap">
      <div class="obs-title">Observação:</div>
      <textarea id="obs_texto" placeholder="Caso necessário, digite a observação aqui..." oninput="setObsPrint(this.value)"></textarea>
    </div>
  </div>

  <!-- =========================
       ✅ PRINT
       ========================= -->
  <div class="print-only">
    <div class="print-bg">
      <img src="img/SESC_1.png" alt="Timbre">
    </div>

    <div class="print-page">
      <div class="cab-paciente">
        <div class="cab-row1">
          <div class="cab-left">
            <div class="cab-lbl2">PACIENTE</div>
            <div class="cab-nome" id="cab_nome"></div>
          </div>
          <div class="cab-right">
            <div class="cab-lbl2">Nº DO EXAME</div>
            <div class="cab-exame" id="cab_exame"></div>
          </div>
        </div>

        <div class="cab-row2">
          <div>DATA DE NASCIMENTO: <span id="cab_nasc"></span></div>
          <div>CARTÃO SUS: <span id="cab_sus"></span></div>
          <div>RUA: <span id="cab_rua"></span></div>
          <div>TELEFONE: <span id="cab_tel"></span></div>
          <div>BAIRRO: <span id="cab_bairro"></span></div>
          <div></div>
          <div>CIDADE: <span id="cab_cidade"></span></div>
          <div></div>
          <div>CEP: <span id="cab_cep"></span></div>
          <div></div>
        </div>
      </div>

      <div class="linha-identificacao"><strong>CONVÊNIO:</strong>&nbsp;UNIDADE MÓVEL SESC SAÚDE MULHER</div>
      <div class="linha-identificacao"><strong>EXAME REALIZADO:</strong>&nbsp;CITOPATOLÓGICO CÉRVICO-VAGINAL/MICROFLORA</div>
      <div class="linha-identificacao"><strong>DATA DA COLETA:</strong>&nbsp;<span id="data_coleta_print"></span></div>
      <div class="linha-identificacao"><strong>RESPONSÁVEL:</strong>&nbsp;<span id="nome_resp_print"></span></div>

      <div class="titulo-laudo">LAUDO DO EXAME CITOPATOLÓGICO DO COLO DO ÚTERO</div>

      <div class="secao-print">
        <span class="tit-negrito">AVALIAÇÃO PRÉ-ANALÍTICA</span><br>
        <span class="tit-normal-caps">ADEQUABILIDADE DO MATERIAL:</span> <span id="p_adeq"></span><br>
        <span class="tit-normal-caps">EPITÉLIOS REPRESENTADOS NA AMOSTRA:</span> <span id="p_epi"></span><br>
        <span class="tit-normal-caps">REPRESENTATIVIDADE DA ZONA DE TRANSFORMAÇÃO:</span> <span id="p_zona"></span>
      </div>

      <div class="secao-print">
        <span id="p_tit_diag" class="tit-negrito">DIAGNÓSTICO DESCRITIVO:</span>
        <div style="display:block;margin-top:5px;">
          <span id="p_subtit_diag" class="tit-normal-caps" style="display:none;">ALTERAÇÕES CELULARES BENIGNAS REATIVAS OU REPARATIVAS:</span>
          <span id="p_res_diag"></span>
        </div>
      </div>

      <div class="secao-print" style="margin-top:-5px;">
        <span class="tit-normal-caps">MICROBIOLOGIA:</span>
        <span id="p_res_micro"></span>
      </div>

      <div class="secao-print">
        <span id="p_tit_concl" class="tit-negrito">CONCLUSÃO:</span>
        <span id="p_res_concl" class="concl-resposta-bloco"></span>
      </div>

      <div class="secao-print" id="obs_print_wrap">
        <strong>Observação:</strong>
        <span id="obs_print"></span>
      </div>

      <div class="rodape-prof">
        <div id="rodape_data"></div>
        <div style="height:10px;"></div>
        <div style="font-weight:800;">Dra. Daniele Carvalho Macêdo</div>
        <div>CRM 12077 PB</div>
      </div>
    </div>
  </div>

</div>

<div class="controles no-print">
  <button class="btn btn-print" onclick="imprimirLaudo()">IMPRIMIR / SALVAR PDF</button>
  <button class="btn btn-word" onclick="baixarWordEVoltar()">BAIXAR WORD (.DOC)</button>
  <button class="btn btn-clear" onclick="location.reload()">LIMPAR</button>
</div>

<script>
  function up(v){ return (v||"").toUpperCase().trim(); }
  function sanitizeFileName(name){
    return (name||"").replace(/[\\/:*?"<>|]/g, "").replace(/\s+/g, " ").trim();
  }

  function forceReflow(){
    void document.documentElement.offsetHeight;
    void document.body.offsetHeight;
  }

  function setObsPrint(texto){
    const wrap = document.getElementById("obs_print_wrap");
    const el = document.getElementById("obs_print");
    const t = (texto||"").trim();
    if(t){
      wrap.style.display = "block";
      el.textContent = " " + t;
    }else{
      wrap.style.display = "none";
      el.textContent = "";
    }
  }

  const params = new URLSearchParams(window.location.search);
  const init = {
    paciente: up(params.get("paciente")),
    exame: up(params.get("exame")),
    data_coleta: up(params.get("data_coleta")),
    data_nascimento: up(params.get("data_nascimento")),
    cartao_sus: up(params.get("cartao_sus")),
    telefone: up(params.get("telefone")),
    rua: up(params.get("rua")),
    bairro: up(params.get("bairro")),
    cidade: up(params.get("cidade")),
    cep: up(params.get("cep")),
    responsavel: up(params.get("responsavel")),
    observacao: (params.get("observacao") || "").trim()
  };

  function preencherCabecalhoPrint(){
    document.getElementById("cab_nome").textContent = init.paciente;
    document.getElementById("cab_exame").textContent = init.exame;
    document.getElementById("cab_nasc").textContent = init.data_nascimento;
    document.getElementById("cab_sus").textContent = init.cartao_sus;
    document.getElementById("cab_tel").textContent = init.telefone;
    document.getElementById("cab_rua").textContent = init.rua;
    document.getElementById("cab_bairro").textContent = init.bairro;
    document.getElementById("cab_cidade").textContent = init.cidade;
    document.getElementById("cab_cep").textContent = init.cep;

    document.getElementById("data_coleta_print").textContent = init.data_coleta;
    document.getElementById("nome_resp_print").textContent = init.responsavel;

    document.getElementById("obs_texto").value = init.observacao;
    setObsPrint(init.observacao);

    const now = new Date();
    const dia = now.getDate();
    const mes = now.toLocaleDateString("pt-BR",{month:"long"});
    const ano = now.getFullYear();
    document.getElementById("rodape_data").textContent = `João Pessoa, ${dia} de ${mes} de ${ano}`;
  }

  preencherCabecalhoPrint();

  function atualizar(){
    const checksEpi = document.querySelectorAll('.epi:checked');

    document.getElementById('p_adeq').textContent =
      document.querySelector('input[name="adeq"]:checked')?.value || '';

    document.getElementById('p_epi').textContent =
      Array.from(checksEpi).map(c => c.value).join(", ");

    document.getElementById('p_zona').textContent =
      document.querySelector('input[name="zona"]:checked')?.value || '';

    const norm = document.getElementById('chk_norm').checked;
    const alts = Array.from(document.querySelectorAll('.alt:checked')).map(c => c.value);

    const pTitDiag = document.getElementById('p_tit_diag');
    const pSubtitDiag = document.getElementById('p_subtit_diag');
    const pResDiag = document.getElementById('p_res_diag');

    if(alts.length > 0){
      pTitDiag.style.display = "inline";
      pSubtitDiag.style.display = "inline";
      pResDiag.textContent = " " + alts.join(", ") + ".";
    }else if(norm){
      pTitDiag.style.display = "none";
      pSubtitDiag.style.display = "none";
      pResDiag.textContent = "DENTRO DOS LIMITES DA NORMALIDADE NO MATERIAL EXAMINADO.";
    }else{
      pTitDiag.style.display = "inline";
      pSubtitDiag.style.display = "none";
      pResDiag.textContent = "";
    }

    const micros = Array.from(document.querySelectorAll('.micro:checked'))
      .map(c => c.getAttribute('data-full') || c.value);

    document.getElementById('p_res_micro').textContent =
      micros.join(", ") + (micros.length ? "." : "");

    const concl = document.querySelector('input[name="c"]:checked');
    const elTitConcl = document.getElementById('p_tit_concl');
    const elResConcl = document.getElementById('p_res_concl');

    if(concl){
      const categoria = concl.getAttribute('data-tit') || "CONCLUSÃO";
      const respostaTecnica = concl.getAttribute('data-full') || concl.value || "";

      elTitConcl.textContent = (concl.value === "NEGATIVO") ? "CONCLUSÃO:" : (categoria + ":");
      elResConcl.textContent = respostaTecnica;
    }else{
      elTitConcl.textContent = "CONCLUSÃO:";
      elResConcl.textContent = "";
    }

    preencherCabecalhoPrint();
  }

  /* ===== Exportação no padrão do sistema ===== */
  function mesChaveAtual(){
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth()+1).padStart(2,"0");
    return `${yyyy}-${mm}`;
  }
  function keyPositivosMes(){ return `positivos_${mesChaveAtual()}`; }

  function salvarCasoPositivoNoStorage(payload){
    const lista = JSON.parse(localStorage.getItem(keyPositivosMes()) || "[]");
    lista.push({ ...payload, data: new Date().toISOString() });
    localStorage.setItem(keyPositivosMes(), JSON.stringify(lista));
  }

  function gerarArquivoExportacaoMes(){
    const mes = mesChaveAtual();
    const lista = JSON.parse(localStorage.getItem(keyPositivosMes()) || "[]");
    const keySistema = `pacientes_${mes}`;

    const registros = lista.map(p => ({
      nome: `${p.exame} ${p.nome}`.trim(),
      telefone: p.telefone || "",
      categoria: p.categoria || "",
      subcategoria: p.subcategoria || ""
    }));

    const exportJSON = { [keySistema]: JSON.stringify(registros) };

    const blob = new Blob([JSON.stringify(exportJSON)], { type:"application/json;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `EXPORT_${mes}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  }

  function nomeArquivoSugerido(){
    const exameSeguro = (init.exame || "").trim().replaceAll("/", ".");
    const nome = (init.paciente || "PACIENTE").trim().toUpperCase();
    return sanitizeFileName(`${exameSeguro} ${nome}`);
  }

  function voltarSistema(){
    const returnUrl = params.get("return");
    if(returnUrl){ window.location.href = returnUrl; return; }
    if(window.history.length > 1){ window.history.back(); return; }
  }

  function imprimirLaudo(){
    atualizar();

    const sugerido = nomeArquivoSugerido();
    const digitado = prompt("Nome do arquivo (PDF):", sugerido);
    if(digitado === null) return;

    const nomeFinal = (digitado || sugerido).trim() || sugerido;

    const tituloOriginal = document.title;
    document.title = nomeFinal;

    try{
      const concl = document.querySelector('input[name="c"]:checked');
      if(concl && concl.value !== "NEGATIVO"){
        const payload = {
          exame: init.exame,
          nome: init.paciente,
          telefone: init.telefone,
          categoria: concl.getAttribute("data-tit") || "",
          subcategoria: (concl.getAttribute("data-full") || concl.value || "").trim()
        };
        salvarCasoPositivoNoStorage(payload);
        gerarArquivoExportacaoMes();
      }
    }catch(e){ console.error(e); }

    forceReflow();
    setTimeout(() => {
      atualizar();
      forceReflow();
      window.print();
      setTimeout(() => { document.title = tituloOriginal; }, 1200);
      setTimeout(() => voltarSistema(), 700);
    }, 180);
  }

  function buildWordHTML(){
    atualizar();
    const bloco = document.querySelector(".print-only .print-page");
    const clone = bloco.cloneNode(true);
    clone.style.display = "block";
    return clone.outerHTML;
  }

  function baixarWordEVoltar(){
    atualizar();

    try{
      const concl = document.querySelector('input[name="c"]:checked');
      if(concl && concl.value !== "NEGATIVO"){
        const payload = {
          exame: init.exame,
          nome: init.paciente,
          telefone: init.telefone,
          categoria: concl.getAttribute("data-tit") || "",
          subcategoria: (concl.getAttribute("data-full") || concl.value || "").trim()
        };
        salvarCasoPositivoNoStorage(payload);
        gerarArquivoExportacaoMes();
      }
    }catch(e){ console.error(e); }

    const htmlWord = buildWordHTML();
    const doc =
`<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>Laudo</title></head>
<body>${htmlWord}</body></html>`;

    const blob = new Blob(['\ufeff', doc], { type: "application/msword" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `${nomeArquivoSugerido()}.doc`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);

    setTimeout(() => voltarSistema(), 700);
  }

  window.atualizar = atualizar;
</script>

</body>
</html>






