<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Laudo</title>

<style>
  :root{
    --blue:#336699;
    --panel:#eef2f7;
    --border:#c7d7e6;
  }

  body{
    margin:0;
    padding:18px;
    background:#f4f4f4;
    font-family: Arial, sans-serif;
  }

  /* ===== CONTROLES ===== */
  .controles{
    position: static;
    margin-top: 18px;
    background:#fff;
    border:1px solid #000;
    padding:14px;
    width: 100%;
    max-width: 420px;
    margin-left:auto;
    margin-right:auto;
    border-radius: 10px;
  }
  .btn{
    width:100%;
    padding:12px;
    font-weight:900;
    cursor:pointer;
    border:none;
    border-radius:6px;
  }
  .btn-print{ background:#28a745;color:#fff; }
  .btn-clear{ margin-top:10px;background:#eee; }

  /* ===== FOLHA ===== */
  .folha{
    width: 210mm;
    min-height: 297mm;
    margin:auto;
    background:#fff;
    box-shadow: 0 0 10px rgba(0,0,0,.12);
    box-sizing:border-box;
    padding:14mm 18mm;
    position:relative;
  }

  /* ===== TELA (FORMULÁRIO) ===== */
  .titulo-laudo{
    text-align:center;
    font-weight:800;
    font-size:12pt;
    margin: 8px 0 14px;
    text-transform:uppercase;
    font-family:"Arial Narrow", Arial, sans-serif;
  }

  .painel{
    background:var(--panel);
    border: 2px solid #7aa4c7;
    border-radius:6px;
    padding:14px 14px 8px;
  }

  .sec{
    border-top: 2px solid #b5cbe0;
    padding-top:10px;
    margin-top:10px;
  }
  .sec:first-child{ border-top:none; padding-top:0; margin-top:0; }

  .sec-title{
    color:var(--blue);
    font-weight:900;
    font-size:10pt;
    text-transform:uppercase;
    margin:0 0 8px;
    font-family:"Arial Narrow", Arial, sans-serif;
  }

  .linha{
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    margin-bottom:10px;
    align-items:center;
    font-family:"Arial Narrow", Arial, sans-serif;
    font-size:11pt;
  }

  .lbl{
    font-weight:900;
    text-transform:uppercase;
    min-width:160px;
  }

  .op-row{
    display:flex;
    gap:16px;
    flex-wrap:wrap;
  }
  .op-row label,
  .op-col label{
    display:flex;
    gap:8px;
    cursor:pointer;
    font-weight:400;
    align-items:flex-start;
  }

  .op-col{
    display:flex;
    flex-direction:column;
    gap:8px;
    margin-top:8px;
  }
  .grupo{
    margin-left:18px;
    display:flex;
    flex-direction:column;
    gap:8px;
    margin-top:6px;
  }

  /* ===== OBSERVAÇÃO (TELA) ===== */
  .obs-wrap{
    margin-top:12px;
    background:#e9eff7;
    border: 2px dashed #9cb6cf;
    border-radius:12px;
    padding:12px;
  }
  .obs-title{
    font-weight:900;
    font-family:"Arial Narrow", Arial, sans-serif;
    font-size:12pt;
    margin-bottom:8px;
  }
  #obs_texto{
    width:100%;
    min-height:110px;
    resize:vertical;
    padding:10px;
    border-radius:10px;
    border:1px solid #b6c7d8;
    font-family:"Arial Narrow", Arial, sans-serif;
    font-size:11pt;
    box-sizing:border-box;
  }

  /* ===== PRINT (LAUDO COMPLETO) ===== */
  .print-only{ display:none; }

  .cab-paciente{
    border-top: 3px solid #00a651;
    border-bottom: 3px solid #00a651;
    padding: 10px 0;
    margin: 0 0 14px;
  }
  .cab-row1{ display:flex; justify-content:space-between; gap:20px; }
  .cab-left{ flex:1; }
  .cab-right{ min-width:220px; text-align:right; }

  .cab-lbl{
    font-size:12pt;
    font-weight:400;
    text-transform:uppercase;
    font-family:"Arial Narrow", Arial, sans-serif;
  }

  .cab-nome, .cab-exame{
    font-size:11.5pt;
    font-weight:700;
    text-transform:uppercase;
    font-family:"Arial Narrow";
    line-height:1.1;
  }

  .cab-row2{
    margin-top:10px;
    display:grid;
    grid-template-columns: 1.2fr 0.8fr;
    gap: 6px 40px;
    font-family:"Arial Narrow", Arial, sans-serif;
    font-size:9.5pt;
    text-transform:uppercase;
    font-weight:400;
  }

  .linha-identificacao{
    font-family:"Arial Narrow", Arial, sans-serif;
    font-size:10pt;
    text-transform:uppercase;
    margin-bottom:4px;
    display:flex;
    gap:6px;
    align-items:baseline;
    white-space:nowrap;
  }

  .secao-print{
    margin-bottom:12px;
    line-height:1.5;
    font-family:"Arial Narrow", Arial, sans-serif;
    font-size:10pt;
    text-align:justify;
  }
  .tit-negrito{ font-weight:700; text-transform:uppercase; }
  .tit-normal-caps{ font-weight:400; text-transform:uppercase; }
  .concl-resposta-bloco{ white-space:pre-line; font-weight:400; display:block; }
  #obs_print_wrap{ display:none; }

  .rodape-prof{
    margin-top:20px;
    text-align:center;
    font-family:"Arial Narrow", Arial, sans-serif;
    font-size:10pt;
  }

  @media print{
    body{ background:#fff; padding:0; }
    .controles{ display:none !important; }
    .folha{ box-shadow:none; width:100%; margin:0; padding:10mm; }
    .no-print{ display:none !important; }
    .print-only{ display:block !important; }
  }
</style>
</head>

<body>

<div class="folha">

  <!-- ✅ TELA -->
  <div class="no-print">
    <div class="titulo-laudo">LAUDO DO EXAME CITOPATOLÓGICO DO COLO DO ÚTERO</div>

    <div class="painel">
      <!-- ✅ SEU FORM COMPLETO (MANTIDO) -->
      <!-- (aqui você mantém exatamente como estava no seu original) -->
      <!-- Para não alongar: cole seu formulário completo aqui (já está no seu arquivo atual) -->
      <!-- ✅ IMPORTANTE: não mexer nessa parte -->
      <!-- ... -->
    </div>

    <div class="obs-wrap">
      <div class="obs-title">Observação:</div>
      <textarea id="obs_texto" placeholder="Caso necessário, digite a observação aqui..." oninput="setObsPrint(this.value)"></textarea>
    </div>
  </div>

  <!-- ✅ IMPRESSÃO -->
  <div class="print-only">
    <!-- seu print-only inteiro (mantido igual) -->
  </div>

</div>

<div class="controles no-print">
  <button class="btn btn-print" onclick="imprimirSalvarPdf()">IMPRIMIR / SALVAR PDF</button>
  <button class="btn btn-clear" onclick="location.reload()">LIMPAR</button>
</div>

<script>
  // ✅ IMPORTANTE: aqui é onde fica toda lógica de export/retorno
  const params = new URLSearchParams(window.location.search);

  function sanitizeFileName(name){
    return (name||"").replace(/[\\/:*?"<>|]/g, "").replace(/\s+/g, " ").trim();
  }
  function up(v){ return (v||"").toUpperCase().trim(); }

  const init = {
    paciente: up(params.get("paciente")),
    exame: up(params.get("exame")),
    telefone: up(params.get("telefone"))
  };

  function nomeArquivoSugerido(){
    const exameSeguro = (init.exame || "").trim().replaceAll("/", ".");
    const nome = (init.paciente || "PACIENTE").trim().toUpperCase();
    return sanitizeFileName(`${exameSeguro} ${nome}`);
  }

  function mesChaveAtual(){
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth()+1).padStart(2,"0");
    return `${yyyy}-${mm}`;
  }
  function keyPositivosMes(){ return `positivos_${mesChaveAtual()}`; }

  function salvarCasoPositivoNoStorage(payload){
    const lista = JSON.parse(localStorage.getItem(keyPositivosMes()) || "[]");
    lista.push({ ...payload, data: new Date().toISOString() });
    localStorage.setItem(keyPositivosMes(), JSON.stringify(lista));
  }

  function gerarArquivoExportacaoMes(){
    const mes = mesChaveAtual();
    const lista = JSON.parse(localStorage.getItem(keyPositivosMes()) || "[]");

    const keySistema = `pacientes_${mes}`;
    const registros = lista.map(p => ({
      nome: `${p.exame} ${p.nome}`.trim(),
      telefone: p.telefone || "",
      categoria: p.categoria || "",
      subcategoria: p.subcategoria || ""
    }));

    const exportJSON = { [keySistema]: JSON.stringify(registros) };

    const blob = new Blob([JSON.stringify(exportJSON)], { type:"application/json;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `EXPORT_${mes}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  }

  function limparEVoltarSistema(){
    const returnUrl = params.get("return");
    if(returnUrl){ window.location.href = returnUrl; return; }
    if(window.history.length > 1){ window.history.back(); return; }
  }

  function imprimirSalvarPdf(){
    // ✅ sugere nome do arquivo no salvar pdf
    document.title = nomeArquivoSugerido();

    // ✅ exporta se POSITIVO
    try{
      const concl = document.querySelector('input[name="c"]:checked');
      if(concl && concl.value !== "NEGATIVO"){
        const payload = {
          exame: init.exame,
          nome: init.paciente,
          telefone: init.telefone,
          categoria: concl.getAttribute("data-tit") || "",
          subcategoria: (concl.getAttribute("data-full") || concl.value || "").trim()
        };
        salvarCasoPositivoNoStorage(payload);
        gerarArquivoExportacaoMes();
      }
    }catch(e){
      console.error(e);
    }

    // ✅ imprime layout perfeito
    window.print();

    // ✅ volta pro sistema
    setTimeout(()=>limparEVoltarSistema(), 700);
  }

  function setObsPrint(){}
</script>

</body>
</html>
