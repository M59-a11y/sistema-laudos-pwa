<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Laudo Citopatológico</title>

<!-- ✅ libs para gerar PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
  :root{ --blue:#336699; --panel:#eef2f7; }
  body{ margin:0; padding:18px; background:#f4f4f4; font-family: Arial, sans-serif; }

  .folha{
    width:210mm; min-height:297mm; margin:auto; background:#fff;
    box-shadow:0 0 10px rgba(0,0,0,.12);
    box-sizing:border-box; padding:14mm 18mm; position:relative;
  }

  .titulo-laudo{
    text-align:center; font-weight:800; font-size:12pt;
    margin:8px 0 14px; text-transform:uppercase;
    font-family:"Arial Narrow", Arial, sans-serif;
  }

  .painel{
    background:var(--panel); border:2px solid #7aa4c7;
    border-radius:6px; padding:14px 14px 8px;
  }

  .sec{ border-top:2px solid #b5cbe0; padding-top:10px; margin-top:10px; }
  .sec:first-child{ border-top:none; padding-top:0; margin-top:0; }

  .sec-title{
    color:var(--blue); font-weight:900; font-size:10pt;
    text-transform:uppercase; margin:0 0 8px;
    font-family:"Arial Narrow", Arial, sans-serif;
  }

  .linha{
    display:flex; gap:12px; flex-wrap:wrap; margin-bottom:10px;
    align-items:center; font-family:"Arial Narrow", Arial, sans-serif; font-size:11pt;
  }
  .lbl{ font-weight:900; text-transform:uppercase; min-width:160px; }

  .op-row{ display:flex; gap:16px; flex-wrap:wrap; }
  .op-row label, .op-col label{
    display:flex; gap:8px; cursor:pointer; font-weight:400; align-items:flex-start;
  }
  .op-col{ display:flex; flex-direction:column; gap:8px; margin-top:8px; }
  .grupo{ margin-left:18px; display:flex; flex-direction:column; gap:8px; margin-top:6px; }

  .obs-wrap{
    margin-top:12px; background:#e9eff7; border:2px dashed #9cb6cf;
    border-radius:12px; padding:12px;
  }
  .obs-title{
    font-weight:900; font-family:"Arial Narrow", Arial, sans-serif; font-size:12pt;
    margin-bottom:8px;
  }
  #obs_texto{
    width:100%; min-height:110px; resize:vertical; padding:10px;
    border-radius:10px; border:1px solid #b6c7d8;
    font-family:"Arial Narrow", Arial, sans-serif; font-size:11pt;
    box-sizing:border-box;
  }

  .controles{
    margin-top:18px; background:#fff; border:1px solid #000; padding:14px;
    width:100%; max-width:420px; margin-left:auto; margin-right:auto; border-radius:10px;
  }
  .btn{ width:100%; padding:12px; font-weight:900; cursor:pointer; border:none; border-radius:6px; }
  .btn-print{ background:#28a745; color:#fff; }
  .btn-clear{ margin-top:10px; background:#eee; }

  /* ===== PRINT-ONLY (laudo) ===== */
  .print-only{ display:none; }

  .cab-paciente{
    border-top:3px solid #00a651; border-bottom:3px solid #00a651;
    padding:10px 0; margin:0 0 14px;
  }
  .cab-row1{ display:flex; justify-content:space-between; gap:20px; }
  .cab-left{ flex:1; }
  .cab-right{ min-width:220px; text-align:right; }
  .cab-lbl{
    font-size:12pt; font-weight:400; text-transform:uppercase;
    font-family:"Arial Narrow", Arial, sans-serif;
  }
  .cab-nome,.cab-exame{
    font-size:11.5pt; font-weight:700; text-transform:uppercase;
    font-family:"Arial Narrow"; line-height:1.1;
  }
  .cab-row2{
    margin-top:10px; display:grid; grid-template-columns:1.2fr 0.8fr;
    gap:6px 40px; font-family:"Arial Narrow", Arial, sans-serif;
    font-size:9.5pt; text-transform:uppercase; font-weight:400;
  }
  .linha-identificacao{
    font-family:"Arial Narrow", Arial, sans-serif; font-size:10pt;
    text-transform:uppercase; margin-bottom:4px; display:flex; gap:6px;
    align-items:baseline; white-space:nowrap;
  }
  .secao-print{
    margin-bottom:12px; line-height:1.5;
    font-family:"Arial Narrow", Arial, sans-serif; font-size:10pt; text-align:justify;
  }
  .tit-negrito{ font-weight:700; text-transform:uppercase; }
  .tit-normal-caps{ font-weight:400; text-transform:uppercase; }
  .concl-resposta-bloco{ white-space:pre-line; font-weight:400; display:block; }
  #obs_print_wrap{ display:none; }

  .rodape-prof{
    margin-top:20px; text-align:center;
    font-family:"Arial Narrow", Arial, sans-serif; font-size:10pt;
  }
</style>
</head>

<body>

<div class="folha">

  <!-- ===== TELA (FORM) ===== -->
  <div class="no-print">
    <div class="titulo-laudo">LAUDO DO EXAME CITOPATOLÓGICO DO COLO DO ÚTERO</div>

    <div class="painel">
      <div class="sec">
        <div class="sec-title">1. Avaliação Pré Analítica</div>
        <div class="linha">
          <div class="lbl">Adequabilidade:</div>
          <div class="op-row">
            <label><input type="radio" name="adeq" value="Satisfatória" onchange="atualizar()"> Satisfatória</label>
            <label><input type="radio" name="adeq" value="Insatisfatória" onchange="atualizar()"> Insatisfatória</label>
          </div>
        </div>

        <div class="linha">
          <div class="lbl">Epitélios:</div>
          <div class="op-row">
            <label><input type="checkbox" class="epi" value="ESCAMOSO" onchange="atualizar()"> Escamoso</label>
            <label><input type="checkbox" class="epi" value="GLANDULAR" onchange="atualizar()"> Glandular</label>
            <label><input type="checkbox" class="epi" value="METAPLÁSICO" onchange="atualizar()"> Metaplásico</label>
          </div>
        </div>

        <div class="linha">
          <div class="lbl">Zona de Transformação:</div>
          <div class="op-row">
            <label><input type="radio" name="zona" id="zona_sim" value="Sim" onchange="atualizar()"> Sim</label>
            <label><input type="radio" name="zona" id="zona_nao" value="Não" onchange="atualizar()"> Não</label>
          </div>
        </div>
      </div>

      <div class="sec">
        <div class="sec-title">2. Diagnóstico Descritivo</div>
        <div class="op-col">
          <label><input type="checkbox" id="chk_norm" onchange="atualizar()"> DENTRO DOS LIMITES DA NORMALIDADE NO MATERIAL EXAMINADO</label>
        </div>

        <div class="linha" style="margin-top:10px;">
          <div class="lbl">ALTERAÇÕES CELULARES BENIGNAS:</div>
        </div>
        <div class="grupo">
          <label><input type="checkbox" class="alt" value="Inflamação" onchange="atualizar()"> Inflamação</label>
          <label><input type="checkbox" class="alt" value="Metaplasia escamosa imatura" onchange="atualizar()"> Metaplasia escamosa imatura</label>
          <label><input type="checkbox" class="alt" value="Reparação" onchange="atualizar()"> Reparação</label>
          <label><input type="checkbox" class="alt" value="Atrofia com inflamação" onchange="atualizar()"> Atrofia com inflamação</label>
          <label><input type="checkbox" class="alt" value="Radiação" onchange="atualizar()"> Radiação</label>
        </div>
      </div>

      <div class="sec">
        <div class="sec-title">3. Microbiologia</div>
        <div class="grupo" style="margin-left:0;">
          <label><input type="checkbox" class="micro" value="Lactobacillus sp" onchange="atualizar()"> Lactobacillus sp</label>
          <label><input type="checkbox" class="micro" value="Cocos" onchange="atualizar()"> Cocos</label>
          <label><input type="checkbox" class="micro" value="Sugestivo de Chlamydia sp" onchange="atualizar()"> Sugestivo de Chlamydia sp</label>
          <label><input type="checkbox" class="micro" value="Actinomyces sp" onchange="atualizar()"> Actinomyces sp</label>
          <label><input type="checkbox" class="micro" value="Candida sp" onchange="atualizar()"> Candida sp</label>
          <label><input type="checkbox" class="micro" value="Trichomonas vaginalis" onchange="atualizar()"> Trichomonas vaginalis</label>
          <label><input type="checkbox" class="micro" data-full="Bacilos supracitoplasmáticos (sugestivos de Gardnerella/Mobiluncus)" value="Gardnerella/Mobiluncus" onchange="atualizar()"> Gardnerella/Mobiluncus</label>
          <label><input type="checkbox" class="micro" data-full="Efeito citopático compatível com vírus do grupo Herpes" value="Vírus Herpes" onchange="atualizar()"> Vírus Herpes</label>
        </div>
      </div>

      <div class="sec">
        <div class="sec-title">4. Conclusão Técnica</div>

        <div class="op-col">
          <label><input type="radio" name="c" data-tit="CONCLUSÃO" data-full="NEGATIVO PARA MALIGNIDADE." value="NEGATIVO" onchange="atualizar()"> NEGATIVO PARA MALIGNIDADE.</label>
        </div>

        <div class="linha" style="margin-top:10px;">
          <div class="lbl">CÉLULAS ATÍPICAS DE SIGNIFICADO INDETERMINADO:</div>
        </div>
        <div class="grupo">
          <label><input type="radio" name="c" data-tit="CÉLULAS ATÍPICAS DE SIGNIFICADO INDETERMINADO" data-full="Escamosas: possivelmente não neoplásicas (ASC-US)" value="ASC-US" onchange="atualizar()"> ESCAMOSAS (ASC-US)</label>
          <label><input type="radio" name="c" data-tit="CÉLULAS ATÍPICAS DE SIGNIFICADO INDETERMINADO" data-full="Escamosas: não se pode afastar lesão intra-epitelial de alto grau (ASC-H)" value="ASC-H" onchange="atualizar()"> ESCAMOSAS (ASC-H)</label>
          <label><input type="radio" name="c" data-tit="CÉLULAS ATÍPICAS DE SIGNIFICADO INDETERMINADO" data-full="Glandulares: possivelmente não neoplásicas" value="GLANDULARES" onchange="atualizar()"> GLANDULARES: Possivelmente não neoplásicas</label>
          <label><input type="radio" name="c" data-tit="CÉLULAS ATÍPICAS DE SIGNIFICADO INDETERMINADO" data-full="Glandulares: não se pode afastar alto grau" value="GLANDULARES_ALTO" onchange="atualizar()"> GLANDULARES: Não se pode afastar alto grau</label>
        </div>

        <div class="linha" style="margin-top:10px;">
          <div class="lbl">ATIPIAS EM CÉLULAS ESCAMOSAS:</div>
        </div>
        <div class="grupo">
          <label><input type="radio" name="c" data-tit="ATIPIAS EM CÉLULAS ESCAMOSAS" data-full="Lesão intra-epitelial de baixo grau (HPV / NIC I)" value="NIC I" onchange="atualizar()"> BAIXO GRAU (HPV / NIC I)</label>
          <label><input type="radio" name="c" data-tit="ATIPIAS EM CÉLULAS ESCAMOSAS" data-full="Lesão intra-epitelial de alto grau (NIC II e III)" value="NIC II/III" onchange="atualizar()"> ALTO GRAU (NIC II / III)</label>
          <label><input type="radio" name="c" data-tit="ATIPIAS EM CÉLULAS ESCAMOSAS" data-full="Carcinoma epidermóide invasor" value="CARCINOMA" onchange="atualizar()"> Carcinoma epidermóide invasor</label>
        </div>

        <div class="linha" style="margin-top:10px;">
          <div class="lbl">ATIPIAS EM CÉLULAS GLANDULARES:</div>
        </div>
        <div class="grupo">
          <label><input type="radio" name="c" data-tit="ATIPIAS EM CÉLULAS GLANDULARES" data-full="Adenocarcinoma in situ" value="ADENO_IN_SITU" onchange="atualizar()"> Adenocarcinoma "in situ"</label>
          <label><input type="radio" name="c" data-tit="ATIPIAS EM CÉLULAS GLANDULARES" data-full="Adenocarcinoma invasor, cervical" value="ADENO_CERVICAL" onchange="atualizar()"> Adenocarcinoma invasor, cervical</label>
          <label><input type="radio" name="c" data-tit="ATIPIAS EM CÉLULAS GLANDULARES" data-full="Adenocarcinoma invasor, endometrial" value="ADENO_ENDOMETRIAL" onchange="atualizar()"> Adenocarcinoma invasor, endometrial</label>
          <label><input type="radio" name="c" data-tit="ATIPIAS EM CÉLULAS GLANDULARES" data-full="Adenocarcinoma invasor, SOE" value="ADENO_SOE" onchange="atualizar()"> Adenocarcinoma invasor, SOE</label>
        </div>
      </div>

    </div><!-- painel -->

    <div class="obs-wrap">
      <div class="obs-title">Observação:</div>
      <div class="op-col" style="margin-bottom:10px;">
        <label><input type="radio" name="obs_opt" value="Tratar e repetir." onchange="aplicarObs(this.value)"> Tratar e repetir.</label>
        <label><input type="radio" name="obs_opt" value="Alterações celulares importantes. Tratar e repetir." onchange="aplicarObs(this.value)"> Alterações celulares importantes. Tratar e repetir.</label>
        <label><input type="radio" name="obs_opt" value="Correlacionar com exames complementares." onchange="aplicarObs(this.value)"> Correlacionar com exames complementares.</label>
        <label><input type="radio" name="obs_opt" value="Padrão epitelial hipoestrogênico." onchange="aplicarObs(this.value)"> Padrão epitelial hipoestrogênico.</label>
        <label><input type="radio" name="obs_opt" value="Padrão epitelial ainda trófico." onchange="aplicarObs(this.value)"> Padrão epitelial ainda trófico.</label>
      </div>
      <textarea id="obs_texto" placeholder="Caso necessário, digite a observação aqui..." oninput="setObsPrint(this.value)"></textarea>
    </div>
  </div>

  <!-- ===== LAUDO (para PDF) ===== -->
  <div class="print-only">
    <div class="cab-paciente">
      <div class="cab-row1">
        <div class="cab-left">
          <div class="cab-lbl">Paciente</div>
          <div class="cab-nome" id="cab_nome"></div>
        </div>
        <div class="cab-right">
          <div class="cab-lbl">Nº do Exame</div>
          <div class="cab-exame" id="cab_exame"></div>
        </div>
      </div>

      <div class="cab-row2">
        <div>DATA DE NASCIMENTO: <span id="cab_nasc"></span></div>
        <div>CARTÃO SUS: <span id="cab_sus"></span></div>
        <div>RUA: <span id="cab_rua"></span></div>
        <div>TELEFONE: <span id="cab_tel"></span></div>
        <div>BAIRRO: <span id="cab_bairro"></span></div>
        <div></div>
        <div>CIDADE: <span id="cab_cidade"></span></div>
        <div></div>
        <div>CEP: <span id="cab_cep"></span></div>
        <div></div>
      </div>
    </div>

    <div class="linha-identificacao"><strong>CONVÊNIO:</strong>&nbsp;UNIDADE MÓVEL SESC SAÚDE MULHER</div>
    <div class="linha-identificacao"><strong>EXAME REALIZADO:</strong>&nbsp;CITOPATOLÓGICO CÉRVICO-VAGINAL/MICROFLORA</div>

    <div class="linha-identificacao"><strong>DATA DA COLETA:</strong> <span id="data_coleta_print"></span></div>
    <div class="linha-identificacao"><strong>RESPONSÁVEL:</strong> <span id="nome_resp_print"></span></div>

    <div class="titulo-laudo">LAUDO DO EXAME CITOPATOLÓGICO DO COLO DO ÚTERO</div>

    <div class="secao-print">
      <span class="tit-negrito">AVALIAÇÃO PRÉ-ANALÍTICA</span><br>
      <span class="tit-normal-caps">ADEQUABILIDADE DO MATERIAL:</span> <span id="p_adeq"></span><br>
      <span class="tit-normal-caps">EPITÉLIOS REPRESENTADOS NA AMOSTRA:</span> <span id="p_epi"></span><br>
      <span class="tit-normal-caps">REPRESENTATIVIDADE DA ZONA DE TRANSFORMAÇÃO:</span> <span id="p_zona"></span>
    </div>

    <div class="secao-print">
      <span id="p_tit_diag" class="tit-negrito">DIAGNÓSTICO DESCRITIVO:</span>
      <div style="display:block;margin-top:5px;">
        <span id="p_subtit_diag" class="tit-normal-caps" style="display:none;">ALTERAÇÕES CELULARES BENIGNAS REATIVAS OU REPARATIVAS:</span>
        <span id="p_res_diag"></span>
      </div>
    </div>

    <div class="secao-print" style="margin-top:-5px;">
      <span class="tit-normal-caps">MICROBIOLOGIA:</span>
      <span id="p_res_micro"></span>
    </div>

    <div class="secao-print">
      <span class="tit-negrito">CONCLUSÃO:</span>
      <span id="p_res_concl" class="concl-resposta-bloco"></span>
    </div>

    <div class="secao-print" id="obs_print_wrap">
      <strong>Observação:</strong>
      <span id="obs_print"></span>
    </div>

    <div class="rodape-prof">
      <div id="rodape_data"></div>
      <div style="height:12px;"></div>
      <div style="font-weight:800;">Dra. Daniele Carvalho Macêdo</div>
      <div>CRM 12077 PB</div>
    </div>
  </div>
</div>

<div class="controles">
  <button class="btn btn-print" onclick="gerarPDF()">GERAR PDF</button>
  <button class="btn btn-clear" onclick="location.reload()">LIMPAR</button>
</div>

<script>
  function sanitizeFileName(name){
    return (name||"").replace(/[\\/:*?"<>|]/g, "").replace(/\s+/g, " ").trim();
  }
  function up(v){ return (v||"").toUpperCase().trim(); }

  const params = new URLSearchParams(window.location.search);
  const init = {
    paciente: up(params.get("paciente")),
    exame: up(params.get("exame")),
    data_coleta: up(params.get("data_coleta")),
    data_nascimento: up(params.get("data_nascimento")),
    cartao_sus: up(params.get("cartao_sus")),
    telefone: up(params.get("telefone")),
    rua: up(params.get("rua")),
    bairro: up(params.get("bairro")),
    cidade: up(params.get("cidade")),
    cep: up(params.get("cep")),
    responsavel: up(params.get("responsavel")),
    observacao: (params.get("observacao") || "").trim()
  };

  // preencher cabeçalho
  document.getElementById("cab_nome").textContent = init.paciente;
  document.getElementById("cab_exame").textContent = init.exame;
  document.getElementById("cab_nasc").textContent = init.data_nascimento;
  document.getElementById("cab_sus").textContent = init.cartao_sus;
  document.getElementById("cab_tel").textContent = init.telefone;
  document.getElementById("cab_rua").textContent = init.rua;
  document.getElementById("cab_bairro").textContent = init.bairro;
  document.getElementById("cab_cidade").textContent = init.cidade;
  document.getElementById("cab_cep").textContent = init.cep;
  document.getElementById("data_coleta_print").textContent = init.data_coleta;
  document.getElementById("nome_resp_print").textContent = init.responsavel;

  // rodapé data
  const hoje = new Date();
  const dia = hoje.getDate();
  const mes = hoje.toLocaleDateString("pt-BR",{month:"long"});
  const ano = hoje.getFullYear();
  document.getElementById("rodape_data").textContent = `João Pessoa, ${dia} de ${mes} de ${ano}`;

  // observação inicial
  document.getElementById("obs_texto").value = init.observacao;
  setObsPrint(init.observacao);

  function setObsPrint(texto){
    const wrap = document.getElementById("obs_print_wrap");
    const el = document.getElementById("obs_print");
    const t = (texto||"").trim();
    if(t){ wrap.style.display="block"; el.textContent=" "+t; }
    else{ wrap.style.display="none"; el.textContent=""; }
  }
  function aplicarObs(txt){
    document.getElementById("obs_texto").value = txt;
    setObsPrint(txt);
  }

  function atualizar(){
    const checksEpi = document.querySelectorAll('.epi:checked');
    if (checksEpi.length > 1) document.getElementById('zona_sim').checked = true;
    else if (checksEpi.length === 1) document.getElementById('zona_nao').checked = true;

    document.getElementById('p_adeq').textContent = document.querySelector('input[name="adeq"]:checked')?.value || '';
    document.getElementById('p_epi').textContent = Array.from(checksEpi).map(c => c.value).join(", ");
    document.getElementById('p_zona').textContent = document.querySelector('input[name="zona"]:checked')?.value || '';

    const norm = document.getElementById('chk_norm').checked;
    const alts = Array.from(document.querySelectorAll('.alt:checked')).map(c => c.value);
    const pTitDiag = document.getElementById('p_tit_diag');
    const pSubtitDiag = document.getElementById('p_subtit_diag');
    const pResDiag = document.getElementById('p_res_diag');

    if(alts.length > 0){
      pTitDiag.style.display="inline";
      pSubtitDiag.style.display="inline";
      pResDiag.textContent=" "+alts.join(", ")+".";
    }else if(norm){
      pTitDiag.style.display="none";
      pSubtitDiag.style.display="none";
      pResDiag.textContent="DENTRO DOS LIMITES DA NORMALIDADE NO MATERIAL EXAMINADO.";
    }else{
      pTitDiag.style.display="inline";
      pSubtitDiag.style.display="none";
      pResDiag.textContent="";
    }

    const micros = Array.from(document.querySelectorAll('.micro:checked')).map(c => c.getAttribute('data-full') || c.value);
    document.getElementById('p_res_micro').textContent = micros.join(", ") + (micros.length ? "." : "");

    const concl = document.querySelector('input[name="c"]:checked');
    if(concl){
      const categoria = concl.getAttribute("data-tit") || "";
      const sub = concl.getAttribute("data-full") || concl.value;
      if(concl.value === "NEGATIVO"){
        document.getElementById('p_res_concl').textContent = sub;
      }else{
        document.getElementById('p_res_concl').textContent = categoria + ":\n" + sub;
      }
    }else{
      document.getElementById('p_res_concl').textContent = "";
    }
  }

  // ===== positivo =====
  const STORAGE_KEY_ATIPIAS = "casos_positivos_atipias";

  function salvarCasoPositivoNoStorage(payload){
    const atual = JSON.parse(localStorage.getItem(STORAGE_KEY_ATIPIAS) || "[]");
    atual.push({ ...payload, data: new Date().toISOString() });
    localStorage.setItem(STORAGE_KEY_ATIPIAS, JSON.stringify(atual));
  }

  function gerarArquivoExportacao(payload){
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth() + 1).padStart(2, "0");
    const mesChave = `${yyyy}-${mm}`;
    const key = `pacientes_${mesChave}`;

    const registro = {
      nome: `${payload.exame} ${payload.nome}`.trim(),
      telefone: payload.telefone || "",
      categoria: payload.categoria || "",
      subcategoria: payload.subcategoria || ""
    };

    const exportJSON = { [key]: JSON.stringify([registro]) };

    const exameSeguro = (payload.exame || "").replaceAll("/", ".");
    const nomeSafe = sanitizeFileName((payload.nome || "").toUpperCase());
    const fileName = `${sanitizeFileName(exameSeguro)} ${nomeSafe} - EXPORT_${mesChave}.json`;

    const blob = new Blob([JSON.stringify(exportJSON)], { type:"application/json;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  }

  function nomeArquivoPDF(){
    const exameSeguro = (init.exame || "").trim().replaceAll("/", ".");
    const nome = (init.paciente || "PACIENTE").trim().toUpperCase();
    return sanitizeFileName(`${exameSeguro} ${nome}.pdf`);
  }

  function limparEVoltarSistema(){
    document.querySelectorAll('input[type="radio"]').forEach(r => r.checked=false);
    document.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked=false);
    document.getElementById("obs_texto").value="";
    setObsPrint("");

    document.getElementById("p_adeq").textContent="";
    document.getElementById("p_epi").textContent="";
    document.getElementById("p_zona").textContent="";
    document.getElementById("p_res_diag").textContent="";
    document.getElementById("p_res_micro").textContent="";
    document.getElementById("p_res_concl").textContent="";

    const returnUrl = params.get("return");
    if(returnUrl){ window.location.href = returnUrl; return; }
    if(window.history.length > 1){ window.history.back(); return; }
  }

  async function gerarPDF(){
    atualizar();

    // ✅ exporta positivo antes do pdf
    const concl = document.querySelector('input[name="c"]:checked');
    if(concl && concl.value !== "NEGATIVO"){
      const categoria = concl.getAttribute("data-tit") || "";
      let subcategoria = concl.getAttribute("data-full") || concl.value || "";
      subcategoria = (subcategoria || "").replace(/^—\s*/,"").trim();

      const payload = {
        exame: init.exame,
        nome: init.paciente,
        telefone: init.telefone,
        categoria,
        subcategoria
      };
      salvarCasoPositivoNoStorage(payload);
      gerarArquivoExportacao(payload);
    }

    const fileName = nomeArquivoPDF();
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p","mm","a4");

    // render fora da tela
    const clone = document.querySelector(".print-only").cloneNode(true);
    const sandbox = document.createElement("div");
    sandbox.style.position="fixed";
    sandbox.style.left="-99999px";
    sandbox.style.top="0";
    sandbox.style.width="210mm";
    sandbox.style.background="white";
    sandbox.style.padding="10mm";
    sandbox.appendChild(clone);
    document.body.appendChild(sandbox);

    const canvas = await html2canvas(clone, {
      scale:2,
      useCORS:true,
      backgroundColor:"#ffffff"
    });

    const imgData = canvas.toDataURL("image/png");
    const pageWidth = 210, pageHeight = 297;
    const imgWidth = pageWidth;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;

    let heightLeft = imgHeight;
    let position = 0;

    doc.addImage(imgData,"PNG",0,position,imgWidth,imgHeight);
    heightLeft -= pageHeight;

    while(heightLeft > 0){
      position = heightLeft - imgHeight;
      doc.addPage();
      doc.addImage(imgData,"PNG",0,position,imgWidth,imgHeight);
      heightLeft -= pageHeight;
    }

    sandbox.remove();
    doc.save(fileName);

    // ✅ garante limpeza/retorno
    setTimeout(()=>limparEVoltarSistema(), 600);
  }

  window.atualizar = atualizar;
  window.aplicarObs = aplicarObs;
</script>
</body>
</html>
