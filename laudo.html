<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Laudo</title>

<style>
  :root{
    --blue:#336699;
    --panel:#eef2f7;
    --border:#c7d7e6;
  }

  body{
    margin:0;
    padding:18px;
    background:#f4f4f4;
    font-family: Arial, sans-serif;
  }

  /* ===== CONTROLES ===== */
  .controles{
    position: static;
    margin-top: 18px;
    background:#fff;
    border:1px solid #000;
    padding:14px;
    width: 100%;
    max-width: 420px;
    margin-left:auto;
    margin-right:auto;
    border-radius: 10px;
  }
  .btn{
    width:100%;
    padding:12px;
    font-weight:900;
    cursor:pointer;
    border:none;
    border-radius:6px;
  }
  .btn-print{ background:#28a745;color:#fff; }
  .btn-word{ margin-top:10px;background:#1f6feb;color:#fff; }
  .btn-clear{ margin-top:10px;background:#eee; }

  /* ===== FOLHA ===== */
  .folha{
    width: 210mm;
    min-height: 297mm;
    margin:auto;
    background:#fff;
    box-shadow: 0 0 10px rgba(0,0,0,.12);
    box-sizing:border-box;
    padding:14mm 18mm;
    position:relative;
  }

  /* ===== TELA (FORMUL√ÅRIO) ===== */
  .titulo-laudo{
    text-align:center;
    font-weight:800;
    font-size:12pt;
    margin: 8px 0 14px;
    text-transform:uppercase;
    font-family:"Arial Narrow", Arial, sans-serif;
  }

  .painel{
    background:var(--panel);
    border: 2px solid #7aa4c7;
    border-radius:6px;
    padding:14px 14px 8px;
  }

  .sec{
    border-top: 2px solid #b5cbe0;
    padding-top:10px;
    margin-top:10px;
  }
  .sec:first-child{ border-top:none; padding-top:0; margin-top:0; }

  .sec-title{
    color:var(--blue);
    font-weight:900;
    font-size:10pt;
    text-transform:uppercase;
    margin:0 0 8px;
    font-family:"Arial Narrow", Arial, sans-serif;
  }

  .linha{
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    margin-bottom:10px;
    align-items:center;
    font-family:"Arial Narrow", Arial, sans-serif;
    font-size:11pt;
  }

  .lbl{
    font-weight:900;
    text-transform:uppercase;
    min-width:160px;
  }

  .op-row{
    display:flex;
    gap:16px;
    flex-wrap:wrap;
  }
  .op-row label,
  .op-col label{
    display:flex;
    gap:8px;
    cursor:pointer;
    font-weight:400;
    align-items:flex-start;
  }

  .op-col{
    display:flex;
    flex-direction:column;
    gap:8px;
    margin-top:8px;
  }
  .grupo{
    margin-left:18px;
    display:flex;
    flex-direction:column;
    gap:8px;
    margin-top:6px;
  }

  /* ===== OBSERVA√á√ÉO (TELA) ===== */
  .obs-wrap{
    margin-top:12px;
    background:#e9eff7;
    border: 2px dashed #9cb6cf;
    border-radius:12px;
    padding:12px;
  }
  .obs-title{
    font-weight:900;
    font-family:"Arial Narrow", Arial, sans-serif;
    font-size:12pt;
    margin-bottom:8px;
  }
  #obs_texto{
    width:100%;
    min-height:110px;
    resize:vertical;
    padding:10px;
    border-radius:10px;
    border:1px solid #b6c7d8;
    font-family:"Arial Narrow", Arial, sans-serif;
    font-size:11pt;
    box-sizing:border-box;
  }

  /* ===== PRINT (LAUDO COMPLETO) ===== */
  .print-only{ display:none; }

  .cab-paciente{
    border-top: 3px solid #00a651;
    border-bottom: 3px solid #00a651;
    padding: 10px 0;
    margin: 0 0 14px;
  }
  .cab-row1{ display:flex; justify-content:space-between; gap:20px; }
  .cab-left{ flex:1; }
  .cab-right{ min-width:220px; text-align:right; }

  .cab-lbl{
    font-size:12pt;
    font-weight:400;
    text-transform:uppercase;
    font-family:"Arial Narrow", Arial, sans-serif;
  }

  .cab-nome, .cab-exame{
    font-size:11.5pt;
    font-weight:700;
    text-transform:uppercase;
    font-family:"Arial Narrow";
    line-height:1.1;
  }

  .cab-row2{
    margin-top:10px;
    display:grid;
    grid-template-columns: 1.2fr 0.8fr;
    gap: 6px 40px;
    font-family:"Arial Narrow", Arial, sans-serif;
    font-size:9.5pt;
    text-transform:uppercase;
    font-weight:400;
  }

  .linha-identificacao{
    font-family:"Arial Narrow", Arial, sans-serif;
    font-size:10pt;
    text-transform:uppercase;
    margin-bottom:4px;
    display:flex;
    gap:6px;
    align-items:baseline;
    white-space:nowrap;
  }

  .secao-print{
    margin-bottom:12px;
    line-height:1.5;
    font-family:"Arial Narrow", Arial, sans-serif;
    font-size:10pt;
    text-align:justify;
  }
  .tit-negrito{ font-weight:700; text-transform:uppercase; }
  .tit-normal-caps{ font-weight:400; text-transform:uppercase; }
  .concl-resposta-bloco{ white-space:pre-line; font-weight:400; display:block; }

  #obs_print_wrap{ display:none; }

  .rodape-prof{
    margin-top:20px;
    text-align:center;
    font-family:"Arial Narrow", Arial, sans-serif;
    font-size:10pt;
  }

  /* ‚úÖ PRINT PERFEITO + sem folha extra */
  @media print{
    body{ background:#fff; padding:0; }
    .controles{ display:none !important; }

    /* ‚úÖ remove min-height s√≥ no print pra n√£o criar folha em branco */
    .folha{
      box-shadow:none;
      width:100%;
      margin:0;
      padding:10mm;
      min-height:auto !important;
      height:auto !important;
    }

    .no-print{ display:none !important; }
    .print-only{ display:block !important; }

    @page{ size:A4; margin:10mm; }
  }
</style>
</head>

<body>

<div class="folha">

  <!-- =========================
       ‚úÖ TELA: SOMENTE PAINEL
       ========================= -->
  <div class="no-print">
    <div class="titulo-laudo">LAUDO DO EXAME CITOPATOL√ìGICO DO COLO DO √öTERO</div>

    <div class="painel">
      <!-- 1 -->
      <div class="sec">
        <div class="sec-title">1. Avalia√ß√£o Pr√© Anal√≠tica</div>

        <div class="linha">
          <div class="lbl">Adequabilidade:</div>
          <div class="op-row">
            <label><input type="radio" name="adeq" value="Satisfat√≥ria" onchange="atualizar()"> Satisfat√≥ria</label>
            <label><input type="radio" name="adeq" value="Insatisfat√≥ria" onchange="atualizar()"> Insatisfat√≥ria</label>
          </div>
        </div>

        <div class="linha">
          <div class="lbl">Epit√©lios:</div>
          <div class="op-row">
            <label><input type="checkbox" class="epi" value="ESCAMOSO" onchange="atualizar()"> Escamoso</label>
            <label><input type="checkbox" class="epi" value="GLANDULAR" onchange="atualizar()"> Glandular</label>
            <label><input type="checkbox" class="epi" value="METAPL√ÅSICO" onchange="atualizar()"> Metapl√°sico</label>
          </div>
        </div>

        <div class="linha">
          <div class="lbl">Zona de Transforma√ß√£o:</div>
          <div class="op-row">
            <label><input type="radio" name="zona" id="zona_sim" value="Sim" onchange="atualizar()"> Sim</label>
            <label><input type="radio" name="zona" id="zona_nao" value="N√£o" onchange="atualizar()"> N√£o</label>
          </div>
        </div>
      </div>

      <!-- 2 -->
      <div class="sec">
        <div class="sec-title">2. Diagn√≥stico Descritivo</div>

        <div class="op-col">
          <label><input type="checkbox" id="chk_norm" onchange="atualizar()"> DENTRO DOS LIMITES DA NORMALIDADE NO MATERIAL EXAMINADO</label>
        </div>

        <div class="linha" style="margin-top:10px;">
          <div class="lbl">ALTERA√á√ïES CELULARES BENIGNAS:</div>
        </div>
        <div class="grupo">
          <label><input type="checkbox" class="alt" value="Inflama√ß√£o" onchange="atualizar()"> Inflama√ß√£o</label>
          <label><input type="checkbox" class="alt" value="Metaplasia escamosa imatura" onchange="atualizar()"> Metaplasia escamosa imatura</label>
          <label><input type="checkbox" class="alt" value="Repara√ß√£o" onchange="atualizar()"> Repara√ß√£o</label>
          <label><input type="checkbox" class="alt" value="Atrofia com inflama√ß√£o" onchange="atualizar()"> Atrofia com inflama√ß√£o</label>
          <label><input type="checkbox" class="alt" value="Radia√ß√£o" onchange="atualizar()"> Radia√ß√£o</label>
        </div>
      </div>

      <!-- 3 -->
      <div class="sec">
        <div class="sec-title">3. Microbiologia</div>
        <div class="grupo" style="margin-left:0;">
          <label><input type="checkbox" class="micro" value="Lactobacillus sp" onchange="atualizar()"> Lactobacillus sp</label>
          <label><input type="checkbox" class="micro" value="Cocos" onchange="atualizar()"> Cocos</label>
          <label><input type="checkbox" class="micro" value="Sugestivo de Chlamydia sp" onchange="atualizar()"> Sugestivo de Chlamydia sp</label>
          <label><input type="checkbox" class="micro" value="Actinomyces sp" onchange="atualizar()"> Actinomyces sp</label>
          <label><input type="checkbox" class="micro" value="Candida sp" onchange="atualizar()"> Candida sp</label>
          <label><input type="checkbox" class="micro" value="Trichomonas vaginalis" onchange="atualizar()"> Trichomonas vaginalis</label>
          <label><input type="checkbox" class="micro" data-full="Bacilos supracitoplasm√°ticos (sugestivos de Gardnerella/Mobiluncus)" value="Gardnerella/Mobiluncus" onchange="atualizar()"> Gardnerella/Mobiluncus</label>
          <label><input type="checkbox" class="micro" data-full="Efeito citop√°tico compat√≠vel com v√≠rus do grupo Herpes" value="V√≠rus Herpes" onchange="atualizar()"> V√≠rus Herpes</label>
        </div>
      </div>

      <!-- 4 -->
      <div class="sec">
        <div class="sec-title">4. Conclus√£o T√©cnica</div>

        <div class="op-col">
          <label><input type="radio" name="c" data-tit="CONCLUS√ÉO" data-full="NEGATIVO PARA MALIGNIDADE." value="NEGATIVO" onchange="atualizar()"> NEGATIVO PARA MALIGNIDADE.</label>
        </div>

        <div class="linha" style="margin-top:10px;">
          <div class="lbl">C√âLULAS AT√çPICAS DE SIGNIFICADO INDETERMINADO:</div>
        </div>
        <div class="grupo">
          <label><input type="radio" name="c" data-tit="C√âLULAS AT√çPICAS DE SIGNIFICADO INDETERMINADO" data-full="Escamosas: possivelmente n√£o neopl√°sicas (ASC-US)" value="ASC-US" onchange="atualizar()"> ESCAMOSAS (ASC-US)</label>
          <label><input type="radio" name="c" data-tit="C√âLULAS AT√çPICAS DE SIGNIFICADO INDETERMINADO" data-full="Escamosas: n√£o se pode afastar les√£o intra-epitelial de alto grau (ASC-H)" value="ASC-H" onchange="atualizar()"> ESCAMOSAS (ASC-H)</label>
          <label><input type="radio" name="c" data-tit="C√âLULAS AT√çPICAS DE SIGNIFICADO INDETERMINADO" data-full="Glandulares: possivelmente n√£o neopl√°sicas" value="GLANDULARES: Possivelmente n√£o neopl√°sicas" onchange="atualizar()"> GLANDULARES: Possivelmente n√£o neopl√°sicas</label>
          <label><input type="radio" name="c" data-tit="C√âLULAS AT√çPICAS DE SIGNIFICADO INDETERMINADO" data-full="Glandulares: n√£o se pode afastar les√£o de alto grau" value="GLANDULARES: N√£o se pode afastar alto grau" onchange="atualizar()"> GLANDULARES: N√£o se pode afastar alto grau</label>
        </div>

        <div class="linha" style="margin-top:10px;">
          <div class="lbl">ATIPIAS EM C√âLULAS ESCAMOSAS:</div>
        </div>
        <div class="grupo">
          <label><input type="radio" name="c" data-tit="ATIPIAS EM C√âLULAS ESCAMOSAS" data-full="Les√£o intra-epitelial de baixo grau (compreendendo efeito citop√°tico pelo v√≠rus HPV e neoplasia intra-epitelial cervical grau I - NIC I)" value="NIC I" onchange="atualizar()"> BAIXO GRAU (HPV / NIC I)</label>
          <label><input type="radio" name="c" data-tit="ATIPIAS EM C√âLULAS ESCAMOSAS" data-full="Les√£o intra-epitelial de alto grau (NIC II e III)" value="NIC II / III" onchange="atualizar()"> ALTO GRAU (NIC II / III)</label>
          <label><input type="radio" name="c" data-tit="ATIPIAS EM C√âLULAS ESCAMOSAS" data-full="Carcinoma epiderm√≥ide invasor" value="Carcinoma" onchange="atualizar()"> Carcinoma epiderm√≥ide invasor</label>
        </div>

        <div class="linha" style="margin-top:10px;">
          <div class="lbl">ATIPIAS EM C√âLULAS GLANDULARES:</div>
        </div>
        <div class="grupo">
          <label><input type="radio" name="c" data-tit="ATIPIAS EM C√âLULAS GLANDULARES" data-full="Adenocarcinoma 'in situ'" value="Adenocarcinoma 'in situ'" onchange="atualizar()"> Adenocarcinoma "in situ"</label>
          <label><input type="radio" name="c" data-tit="ATIPIAS EM C√âLULAS GLANDULARES" data-full="Adenocarcinoma invasor, cervical" value="Adenocarcinoma cervical" onchange="atualizar()"> Adenocarcinoma invasor, cervical</label>
          <label><input type="radio" name="c" data-tit="ATIPIAS EM C√âLULAS GLANDULARES" data-full="Adenocarcinoma invasor, endometrial" value="Adenocarcinoma endometrial" onchange="atualizar()"> Adenocarcinoma invasor, endometrial</label>
          <label><input type="radio" name="c" data-tit="ATIPIAS EM C√âLULAS GLANDULARES" data-full="Adenocarcinoma invasor, SOE" value="Adenocarcinoma SOE" onchange="atualizar()"> Adenocarcinoma invasor, SOE</label>
        </div>
      </div>
    </div><!-- painel -->

    <!-- Observa√ß√£o -->
    <div class="obs-wrap">
      <div class="obs-title">Observa√ß√£o:</div>

      <div class="op-col" style="margin-bottom:10px;">
        <label><input type="radio" name="obs_opt" value="Tratar e repetir." onchange="aplicarObs(this.value)"> Tratar e repetir.</label>
        <label><input type="radio" name="obs_opt" value="Altera√ß√µes celulares importantes. Tratar e repetir." onchange="aplicarObs(this.value)"> Altera√ß√µes celulares importantes. Tratar e repetir.</label>
        <label><input type="radio" name="obs_opt" value="Correlacionar com exames complementares." onchange="aplicarObs(this.value)"> Correlacionar com exames complementares.</label>
        <label><input type="radio" name="obs_opt" value="Padr√£o epitelial hipoestrog√™nico." onchange="aplicarObs(this.value)"> Padr√£o epitelial hipoestrog√™nico.</label>
        <label><input type="radio" name="obs_opt" value="Padr√£o epitelial ainda tr√≥fico." onchange="aplicarObs(this.value)"> Padr√£o epitelial ainda tr√≥fico.</label>
      </div>

      <textarea id="obs_texto" placeholder="Caso necess√°rio, digite a observa√ß√£o aqui..." oninput="setObsPrint(this.value)"></textarea>
    </div>

  </div><!-- /no-print -->

  <!-- =========================
       ‚úÖ IMPRESS√ÉO: LAUDO COMPLETO
       ========================= -->
  <div class="print-only">

    <div class="cab-paciente">
      <div class="cab-row1">
        <div class="cab-left">
          <div class="cab-lbl">PACIENTE</div>
          <div class="cab-nome" id="cab_nome"></div>
        </div>
        <div class="cab-right">
          <div class="cab-lbl">N¬∫ DO EXAME</div>
          <div class="cab-exame" id="cab_exame"></div>
        </div>
      </div>

      <div class="cab-row2">
        <div>DATA DE NASCIMENTO: <span id="cab_nasc"></span></div>
        <div>CART√ÉO SUS: <span id="cab_sus"></span></div>
        <div>RUA: <span id="cab_rua"></span></div>
        <div>TELEFONE: <span id="cab_tel"></span></div>
        <div>BAIRRO: <span id="cab_bairro"></span></div>
        <div></div>
        <div>CIDADE: <span id="cab_cidade"></span></div>
        <div></div>
        <div>CEP: <span id="cab_cep"></span></div>
        <div></div>
      </div>
    </div>

    <div class="linha-identificacao"><strong>CONV√äNIO:</strong>&nbsp;UNIDADE M√ìVEL SESC SA√öDE MULHER</div>
    <div class="linha-identificacao"><strong>EXAME REALIZADO:</strong>&nbsp;CITOPATOL√ìGICO C√âRVICO-VAGINAL/MICROFLORA</div>

    <div class="linha-identificacao">
      <strong>DATA DA COLETA:</strong>
      <span id="data_coleta_print"></span>
    </div>

    <div class="linha-identificacao">
      <strong>RESPONS√ÅVEL:</strong>
      <span id="nome_resp_print"></span>
    </div>

    <div class="titulo-laudo">LAUDO DO EXAME CITOPATOL√ìGICO DO COLO DO √öTERO</div>

    <div class="secao-print">
      <span class="tit-negrito">AVALIA√á√ÉO PR√â-ANAL√çTICA</span><br>
      <span class="tit-normal-caps">ADEQUABILIDADE DO MATERIAL:</span> <span id="p_adeq"></span><br>
      <span class="tit-normal-caps">EPIT√âLIOS REPRESENTADOS NA AMOSTRA:</span> <span id="p_epi"></span><br>
      <span class="tit-normal-caps">REPRESENTATIVIDADE DA ZONA DE TRANSFORMA√á√ÉO:</span> <span id="p_zona"></span>
    </div>

    <div class="secao-print">
      <span id="p_tit_diag" class="tit-negrito">DIAGN√ìSTICO DESCRITIVO:</span>
      <div style="display:block;margin-top:5px;">
        <span id="p_subtit_diag" class="tit-normal-caps" style="display:none;">ALTERA√á√ïES CELULARES BENIGNAS REATIVAS OU REPARATIVAS:</span>
        <span id="p_res_diag"></span>
      </div>
    </div>

    <div class="secao-print" style="margin-top:-5px;">
      <span class="tit-normal-caps">MICROBIOLOGIA:</span>
      <span id="p_res_micro"></span>
    </div>

    <div class="secao-print">
      <span id="p_tit_concl" class="tit-negrito">CONCLUS√ÉO:</span>
      <span id="p_res_concl" class="concl-resposta-bloco"></span>
    </div>

    <div class="secao-print" id="obs_print_wrap">
      <strong>Observa√ß√£o:</strong>
      <span id="obs_print"></span>
    </div>

    <div class="rodape-prof">
      <div id="rodape_data"></div>
      <div style="height:12px;"></div>
      <div style="font-weight:800;">Dra. Daniele Carvalho Mac√™do</div>
      <div>CRM 12077 PB</div>
    </div>
  </div>

</div><!-- /folha -->

<!-- ‚úÖ BOT√ïES -->
<div class="controles no-print">
  <button class="btn btn-print" onclick="imprimirLaudo()">IMPRIMIR / SALVAR PDF</button>
  <button class="btn btn-word" onclick="abrirLaudoWord()">ABRIR PARA COPIAR NO WORD</button>
  <button class="btn btn-clear" onclick="location.reload()">LIMPAR</button>
</div>

<script>
  function onlyDigits(s){ return (s||"").replace(/\D/g,''); }
  function up(v){ return (v||"").toUpperCase().trim(); }
  function sanitizeFileName(name){
    return (name||"").replace(/[\\/:*?"<>|]/g, "").replace(/\s+/g, " ").trim();
  }

  function setObsPrint(texto){
    const wrap = document.getElementById("obs_print_wrap");
    const el = document.getElementById("obs_print");
    const t = (texto||"").trim();
    if(t){
      wrap.style.display = "block";
      el.textContent = " " + t;
    }else{
      wrap.style.display = "none";
      el.textContent = "";
    }
  }

  function aplicarObs(txt){
    const el = document.getElementById("obs_texto");
    el.value = txt;
    setObsPrint(txt);
  }

  // ===== INIT DADOS DO SISTEMA PRINCIPAL =====
  const params = new URLSearchParams(window.location.search);

  const init = {
    paciente: up(params.get("paciente")),
    exame: up(params.get("exame")),
    data_coleta: up(params.get("data_coleta")),
    data_nascimento: up(params.get("data_nascimento")),
    cartao_sus: up(params.get("cartao_sus")),
    telefone: up(params.get("telefone")),
    rua: up(params.get("rua")),
    bairro: up(params.get("bairro")),
    cidade: up(params.get("cidade")),
    cep: up(params.get("cep")),
    responsavel: up(params.get("responsavel")),
    observacao: (params.get("observacao") || "").trim()
  };

  document.getElementById("cab_nome").textContent = init.paciente;
  document.getElementById("cab_exame").textContent = init.exame;
  document.getElementById("cab_nasc").textContent = init.data_nascimento;
  document.getElementById("cab_sus").textContent = init.cartao_sus;
  document.getElementById("cab_tel").textContent = init.telefone;
  document.getElementById("cab_rua").textContent = init.rua;
  document.getElementById("cab_bairro").textContent = init.bairro;
  document.getElementById("cab_cidade").textContent = init.cidade;
  document.getElementById("cab_cep").textContent = init.cep;

  document.getElementById("data_coleta_print").textContent = init.data_coleta;
  document.getElementById("nome_resp_print").textContent = init.responsavel;

  document.getElementById("obs_texto").value = init.observacao;
  setObsPrint(init.observacao);

  // Rodap√© com data completa
  const hoje = new Date();
  const dia = hoje.getDate();
  const mes = hoje.toLocaleDateString("pt-BR",{month:"long"});
  const ano = hoje.getFullYear();
  document.getElementById("rodape_data").textContent = `Jo√£o Pessoa, ${dia} de ${mes} de ${ano}`;

  function atualizar(){
    const checksEpi = document.querySelectorAll('.epi:checked');
    const zonaSim = document.getElementById('zona_sim');
    const zonaNao = document.getElementById('zona_nao');

    if (checksEpi.length > 1) zonaSim.checked = true;
    else if (checksEpi.length === 1) zonaNao.checked = true;

    document.getElementById('p_adeq').textContent = document.querySelector('input[name="adeq"]:checked')?.value || '';
    document.getElementById('p_epi').textContent = Array.from(checksEpi).map(c => c.value).join(", ");
    document.getElementById('p_zona').textContent = document.querySelector('input[name="zona"]:checked')?.value || '';

    const norm = document.getElementById('chk_norm').checked;
    const alts = Array.from(document.querySelectorAll('.alt:checked')).map(c => c.value);
    const pTitDiag = document.getElementById('p_tit_diag');
    const pSubtitDiag = document.getElementById('p_subtit_diag');
    const pResDiag = document.getElementById('p_res_diag');

    if(alts.length > 0){
      pTitDiag.style.display = "inline";
      pSubtitDiag.style.display = "inline";
      pResDiag.textContent = " " + alts.join(", ") + ".";
    }else if(norm){
      pTitDiag.style.display = "none";
      pSubtitDiag.style.display = "none";
      pResDiag.textContent = "DENTRO DOS LIMITES DA NORMALIDADE NO MATERIAL EXAMINADO.";
    }else{
      pTitDiag.style.display = "inline";
      pSubtitDiag.style.display = "none";
      pResDiag.textContent = "";
    }

    const micros = Array.from(document.querySelectorAll('.micro:checked')).map(c => c.getAttribute('data-full') || c.value);
    document.getElementById('p_res_micro').textContent = micros.join(", ") + (micros.length ? "." : "");

    const concl = document.querySelector('input[name="c"]:checked');
    if(concl){
      const categoria = concl.getAttribute('data-tit');
      const respostaTecnica = concl.getAttribute('data-full') || concl.value;
      if(concl.value === "NEGATIVO"){
        document.getElementById('p_res_concl').textContent = respostaTecnica;
      }else{
        document.getElementById('p_res_concl').textContent = categoria + ":\n" + respostaTecnica;
      }
    }else{
      document.getElementById('p_res_concl').textContent = "";
    }
  }

  /* ==========================================================
     ‚úÖ POPUP WORD COM C√ìPIA AUTOM√ÅTICA + FORMATA√á√ÉO (HTML clipboard)
  ========================================================== */
  function abrirLaudoEmJanelaWord(laudoHTML, titulo = "Laudo - Copiar para Word") {
    const w = window.open("", "_blank", "width=950,height=750,scrollbars=yes,resizable=yes");
    if (!w) {
      alert("Pop-up bloqueado! Permita pop-ups para este site.");
      return;
    }

    w.document.open();
    w.document.write(`
      <!DOCTYPE html>
      <html lang="pt-BR">
      <head>
        <meta charset="UTF-8" />
        <title>${titulo}</title>
        <style>
          body{ font-family: Arial, sans-serif; padding:20px; background:#f6f6f6; }
          .topo{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:14px; }
          button{ padding:10px 14px; border:0; border-radius:10px; font-weight:800; cursor:pointer; }
          .btnCopiar{ background:#2e7d32; color:#fff; }
          .btnFechar{ background:#b71c1c; color:#fff; }
          .btnSelecionar{ background:#1f6feb; color:#fff; }
          .card{
            background:#fff;
            border:1px solid #ddd;
            border-radius:14px;
            padding:18px;
            line-height:1.5;
            font-size:14px;
          }
          .aviso{ margin-left:auto; font-size:12px; opacity:0.85; }

          /* ‚úÖ CSS do laudo dentro do popup */
          .cab-paciente{ border-top:3px solid #00a651; border-bottom:3px solid #00a651; padding:10px 0; margin:0 0 14px; }
          .cab-row1{ display:flex; justify-content:space-between; gap:20px; }
          .cab-left{ flex:1; }
          .cab-right{ min-width:220px; text-align:right; }
          .cab-lbl{ font-size:12pt; font-weight:400; text-transform:uppercase; font-family:"Arial Narrow", Arial, sans-serif; }
          .cab-nome,.cab-exame{ font-size:11.5pt; font-weight:700; text-transform:uppercase; font-family:"Arial Narrow"; line-height:1.1; }
          .cab-row2{ margin-top:10px; display:grid; grid-template-columns:1.2fr 0.8fr; gap:6px 40px; font-family:"Arial Narrow", Arial, sans-serif; font-size:9.5pt; text-transform:uppercase; font-weight:400; }
          .linha-identificacao{ font-family:"Arial Narrow", Arial, sans-serif; font-size:10pt; text-transform:uppercase; margin-bottom:4px; display:flex; gap:6px; align-items:baseline; white-space:nowrap; }
          .titulo-laudo{ text-align:center; font-weight:800; font-size:12pt; margin:8px 0 14px; text-transform:uppercase; font-family:"Arial Narrow", Arial, sans-serif; }
          .secao-print{ margin-bottom:12px; line-height:1.5; font-family:"Arial Narrow", Arial, sans-serif; font-size:10pt; text-align:justify; }
          .tit-negrito{ font-weight:700; text-transform:uppercase; }
          .tit-normal-caps{ font-weight:400; text-transform:uppercase; }
          .concl-resposta-bloco{ white-space:pre-line; font-weight:400; display:block; }
          .rodape-prof{ margin-top:20px; text-align:center; font-family:"Arial Narrow", Arial, sans-serif; font-size:10pt; }
        </style>
      </head>
      <body>
        <div class="topo">
          <button class="btnCopiar" onclick="copiarHTML()">üìã Copiar laudo formatado</button>
          <button class="btnSelecionar" onclick="selecionar()">üñ±Ô∏è Selecionar tudo</button>
          <button class="btnFechar" onclick="window.close()">‚úñ Fechar</button>
          <span class="aviso" id="msg"></span>
        </div>

        <div id="laudo" class="card">${laudoHTML}</div>

        <script>
          function selecionar(){
            const el = document.getElementById('laudo');
            const range = document.createRange();
            range.selectNodeContents(el);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
          }

          async function copiarHTML(){
            const el = document.getElementById('laudo');
            const html = el.innerHTML;
            const texto = el.innerText;

            try{
              if(navigator.clipboard && window.ClipboardItem){
                const blobHTML = new Blob([html], {type: "text/html"});
                const blobTXT  = new Blob([texto], {type: "text/plain"});

                await navigator.clipboard.write([
                  new ClipboardItem({
                    "text/html": blobHTML,
                    "text/plain": blobTXT
                  })
                ]);

                document.getElementById('msg').textContent = "‚úÖ Copiado com formata√ß√£o! Cole no Word (Ctrl+V).";
              }else{
                selecionar();
                document.execCommand('copy');
                window.getSelection().removeAllRanges();
                document.getElementById('msg').textContent = "‚úÖ Copiado! (fallback)";
              }
            }catch(e){
              console.error(e);
              document.getElementById('msg').textContent = "‚ö†Ô∏è N√£o consegui copiar automaticamente. Selecione e use Ctrl+C.";
            }
          }

          window.onload = function(){
            setTimeout(copiarHTML, 250);
          }
        <\/script>
      </body>
      </html>
    `);
    w.document.close();
  }

  function montarLaudoHTMLWord(){
    atualizar();
    const bloco = document.querySelector(".print-only");
    const clone = bloco.cloneNode(true);
    clone.style.display = "block";
    return clone.innerHTML;
  }

  function abrirLaudoWord(){
    const html = montarLaudoHTMLWord();
    abrirLaudoEmJanelaWord(html, `Laudo ${init.exame} - ${init.paciente}`);
  }

  // ===== Exporta√ß√£o no padr√£o do sistema (MANTIDO) =====
  function mesChaveAtual(){
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth()+1).padStart(2,"0");
    return `${yyyy}-${mm}`;
  }
  function keyPositivosMes(){ return `positivos_${mesChaveAtual()}`; }

  function salvarCasoPositivoNoStorage(payload){
    const lista = JSON.parse(localStorage.getItem(keyPositivosMes()) || "[]");
    lista.push({ ...payload, data: new Date().toISOString() });
    localStorage.setItem(keyPositivosMes(), JSON.stringify(lista));
  }

  function gerarArquivoExportacaoMes(){
    const mes = mesChaveAtual();
    const lista = JSON.parse(localStorage.getItem(keyPositivosMes()) || "[]");
    const keySistema = `pacientes_${mes}`;

    const registros = lista.map(p => ({
      nome: `${p.exame} ${p.nome}`.trim(),
      telefone: p.telefone || "",
      categoria: p.categoria || "",
      subcategoria: p.subcategoria || ""
    }));

    const exportJSON = { [keySistema]: JSON.stringify(registros) };

    const blob = new Blob([JSON.stringify(exportJSON)], { type:"application/json;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `EXPORT_${mes}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  }

  function nomeArquivoSugerido(){
    const exameSeguro = (init.exame || "").trim().replaceAll("/", ".");
    const nome = (init.paciente || "PACIENTE").trim().toUpperCase();
    return sanitizeFileName(`${exameSeguro} ${nome}`);
  }

  function voltarSistema(){
    const returnUrl = params.get("return");
    if(returnUrl){ window.location.href = returnUrl; return; }
    if(window.history.length > 1){ window.history.back(); return; }
  }

  // ‚úÖ IMPRIMIR (sugere nome + exporta + volta)
  function imprimirLaudo(){
    atualizar();

    const sugerido = nomeArquivoSugerido();
    const digitado = prompt("Nome do arquivo (PDF):", sugerido);
    if(digitado === null) return;

    const nomeFinal = (digitado || sugerido).trim() || sugerido;

    const tituloOriginal = document.title;
    document.title = nomeFinal;

    try{
      const concl = document.querySelector('input[name="c"]:checked');
      if(concl && concl.value !== "NEGATIVO"){
        const payload = {
          exame: init.exame,
          nome: init.paciente,
          telefone: init.telefone,
          categoria: concl.getAttribute("data-tit") || "",
          subcategoria: (concl.getAttribute("data-full") || concl.value || "").trim()
        };
        salvarCasoPositivoNoStorage(payload);
        gerarArquivoExportacaoMes();
      }
    }catch(e){ console.error(e); }

    window.print();

    setTimeout(() => { document.title = tituloOriginal; }, 1200);
    setTimeout(() => voltarSistema(), 700);
  }

  window.atualizar = atualizar;
  window.abrirLaudoWord = abrirLaudoWord;
</script>

</body>
</html>




