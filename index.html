<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Sistema-Laudo (Principal)</title>

<!-- ✅ PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0078d7">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>
  :root{
    --bgA:#baf2c7;
    --bgB:#0a2a47;
    --bgC:#061a2e;

    --glass:rgba(255,255,255,.10);
    --glass2:rgba(255,255,255,.06);
    --line:rgba(255,255,255,.18);

    --txt:#f5fbff;
    --muted:rgba(255,255,255,.78);

    --shadow:0 18px 40px rgba(0,0,0,.32);
    --shadow2:0 6px 24px rgba(0,0,0,.24);

    --r22:22px;

    --accent:#00d36d;
    --accent2:#00a651;
    --danger:#ff4d4d;
  }

  *{box-sizing:border-box}
  html,body{height:100%}

  body{
    margin:0;
    font-family:"Segoe UI", Roboto, Arial, sans-serif;
    background: linear-gradient(90deg, var(--bgA) 0%, var(--bgB) 60%, var(--bgC) 100%);
    color:var(--txt);
    overflow:hidden; /* ✅ zero scroll */
  }

  /* ✅ Marca d’água */
  .watermark{
    position:fixed;
    top:88px;
    right:24px;
    width:min(46vw, 720px);
    height:calc(100vh - 110px);
    background:url("logo/logotipo.png") no-repeat right center;
    background-size:contain;
    opacity:.07;
    pointer-events:none;
    z-index:0;
    filter: saturate(.9) contrast(1.05);
  }

  /* ✅ Shell */
  .shell{
    height:100vh;
    display:flex;
    flex-direction:column;
    max-width:1180px;
    margin:0 auto;
    padding:18px;
    position:relative;
    z-index:1;
  }

  /* ✅ Header */
  .hdr{
    height:84px;
    padding:14px 22px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    border-bottom:1px solid rgba(255,255,255,.12);
    background: linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.00));
    border-radius: var(--r22);
    backdrop-filter: blur(10px);
    box-shadow: var(--shadow2);
    flex:0 0 auto;
  }

  .brand{display:flex;align-items:center;gap:14px;min-width:320px;}
  .brand img{
    width:170px;max-height:52px;height:auto;object-fit:contain;display:block;
    filter: drop-shadow(0 10px 16px rgba(0,0,0,.35));
  }
  .brand-info{display:flex;flex-direction:column;line-height:1.05;color:var(--txt);}
  .brand-info strong{
    font-size:14px;letter-spacing:.20em;text-transform:uppercase;font-weight:900;
    color: rgba(255,255,255,.92);
  }
  .brand-info span{margin-top:6px;font-size:12px;color:rgba(255,255,255,.68);}

  /* ✅ Card Desenvolvedor */
  .dev-card{
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    text-align:center;
    padding:10px 16px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.18);
    box-shadow: var(--shadow2);
    backdrop-filter: blur(10px);
    min-width:260px;
  }
  .dev-card .name{
    font-weight:1000;
    letter-spacing:.20em;
    text-transform:uppercase;
    font-size:13px;
    color:rgba(255,255,255,.96);
    line-height:1.1;
  }
  .dev-card .role{
    margin-top:4px;
    font-size:11px;              /* ✅ menor */
    letter-spacing:.22em;
    text-transform:uppercase;
    color:rgba(255,255,255,.72);
    line-height:1.1;
  }

  /* ✅ Main card */
  .card{
    margin-top:14px;
    border-radius: var(--r22);
    border:1px solid var(--line);
    background: linear-gradient(180deg, var(--glass), var(--glass2));
    box-shadow: var(--shadow);
    overflow:hidden;
    flex:1 1 auto;
    min-height:0;
    display:flex;
    flex-direction:column;
  }

  .card-h{
    padding:14px 16px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    border-bottom:1px solid rgba(255,255,255,.10);
    flex:0 0 auto;
  }

  .card-h h1{
    margin:0;
    font-size:14px;
    letter-spacing:.16em;
    text-transform:uppercase;
    font-weight:900;
  }

  .pill{
    padding:9px 12px;border-radius:999px;
    border:1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.18);
    font-size:12px;color:rgba(255,255,255,.86);
    letter-spacing:.04em;user-select:none;
    backdrop-filter: blur(10px);
    box-shadow: var(--shadow2);
  }

  .card-b{
    padding:16px;
    display:grid;
    grid-template-columns: 1fr 380px;
    gap:16px;
    min-height:0;
    flex:1 1 auto;
  }

  /* ✅ painel de digitação */
  .panel{
    border-radius: var(--r22);
    border:1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.22);
    box-shadow: var(--shadow2);
    overflow:hidden;
    display:flex;
    flex-direction:column;
    min-height:0;
  }

  .panel-h{
    padding:12px 14px;
    border-bottom:1px solid rgba(255,255,255,.12);
    display:flex;
    justify-content:space-between;
    align-items:center;
  }

  .panel-h strong{
    font-size:12px;
    letter-spacing:.22em;
    text-transform:uppercase;
    font-weight:900;
    color:rgba(255,255,255,.92);
  }

  .guide{
    font-size:11px;
    letter-spacing:.12em;
    color:rgba(255,255,255,.70);
    text-transform:uppercase;
    white-space:nowrap;
  }

  .panel-b{
    padding:14px;
    display:flex;
    flex-direction:column;
    gap:10px;
    min-height:0;
  }

  textarea{
    width:100%;
    min-height:0;
    height:100%;
    flex:1 1 auto;
    resize:none;
    padding:12px 12px;
    font-size:14px;
    line-height:1.35;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.08);
    color: rgba(255,255,255,.92);
    outline:none;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
    white-space:pre-wrap;
  }
  textarea::placeholder{ color:rgba(255,255,255,.40); }

  /* ✅ botões */
  .btn{
    width:100%;
    padding:14px;
    border:none;
    border-radius:16px;
    font-weight:1000;
    letter-spacing:.06em;
    text-transform:uppercase;
    cursor:pointer;
  }
  .btn-green{ background: linear-gradient(180deg, #19e27b, #00a651); color:#062014; }
  .btn-green:hover{ filter:brightness(1.04); }

  .hint{
    font-size:12px;
    color:rgba(255,255,255,.74);
    line-height:1.4;
    margin-top:2px;
  }

  /* ✅ campos técnicos (não precisa exibir) */
  .hidden-tech{ display:none !important; }

  /* ✅ responsivo */
  @media (max-width: 1060px){
    body{overflow:auto;}
    .shell{height:auto; min-height:100vh;}
    .card{min-height:720px;}
    .card-b{grid-template-columns:1fr;}
  }
</style>
</head>

<body>
<div class="watermark" aria-hidden="true"></div>

<div class="shell">
  <!-- ✅ Header -->
  <div class="hdr">
    <div class="brand">
      <img src="logo/sesctopo.png" alt="SESC" />
      <div class="brand-info">
        <strong>SI - SISTEMA DE INFORMAÇÃO</strong>
        <span>Sistema de Laudos • Extração e abertura do Laudo</span>
      </div>
    </div>

    <!-- ✅ Card elegante do desenvolvedor -->
    <div class="dev-card" aria-label="Desenvolvedor">
      <div class="name">MARCOS PONTES</div>
      <div class="role">DESENVOLVEDOR</div>
    </div>
  </div>

  <!-- ✅ Card principal -->
  <div class="card">
    <div class="card-h">
      <h1>Sistema de Laudos</h1>
      <div class="pill">Zero Scroll • Interface Premium</div>
    </div>

    <div class="card-b">
      <!-- ✅ Digitação rápida -->
      <div class="panel">
        <div class="panel-h">
          <strong>Digitação Rápida</strong>
          <div class="guide">Data da Coleta | Data de Nascimento | Cartão SUS | Telefone | Rua</div>
        </div>

        <div class="panel-b">
          <textarea id="entrada_rapida" rows="12" placeholder="MODELO:
MARIA APARECIDA DA SILVA 000156/2026
01/12/2025
18/01/1976
50037048449
83985567895
RUA: LINDOLFO GONÇALVES CHAVES, 900
BAIRRO: JARDIM SÃO PAULO
CIDADE: JOÃO PESSOA/PB
CEP: 58051-200
SNM"></textarea>

          <button class="btn btn-green" onclick="extrairEAbrir()">
            Extrair automaticamente e abrir laudo
          </button>

          <div class="hint">
            ✅ Última linha pode ser: <b>SNM</b> ou <b>EAM</b> (Responsável).<br>
            ✅ O nome não quebra: exame detectado por padrão <b>000156/2026</b>.
          </div>
        </div>
      </div>

      <!-- ✅ Campos de destino (invisíveis - permanecem no código) -->
      <div class="hidden-tech">
        <input id="paciente" type="text" />
        <input id="exame" type="text" />
        <input id="data_coleta" type="text" />
        <input id="data_nascimento" type="text" />
        <input id="cartao_sus" type="text" />
        <input id="telefone" type="text" />
        <input id="rua" type="text" />
        <input id="bairro" type="text" />
        <input id="cidade" type="text" />
        <input id="cep" type="text" />
        <select id="responsavel">
          <option value="">Selecione...</option>
          <option value="SHEINA N. MORAIS RAMALHO">SHEINA N. MORAIS RAMALHO</option>
          <option value="EDVÂNIA APARECIDA MENDES DE AZEVÊDO">EDVÂNIA APARECIDA MENDES DE AZEVÊDO</option>
        </select>
        <input id="observacao" type="text" />
      </div>
    </div>
  </div>
</div>

<script>
function onlyDigits(s){ return (s||"").replace(/\D/g,''); }
function up(v){ return (v||"").toUpperCase().trim(); }

function maskDate(v){
  let d = onlyDigits(v).slice(0,8);
  if(d.length >= 5) return d.replace(/(\d{2})(\d{2})(\d+)/,'$1/$2/$3');
  if(d.length >= 3) return d.replace(/(\d{2})(\d+)/,'$1/$2');
  return d;
}
function maskCep(v){
  let c = onlyDigits(v).slice(0,8);
  if(c.length > 5) return c.replace(/(\d{5})(\d+)/,'$1-$2');
  return c;
}
function maskPhone(v){
  let t = onlyDigits(v).slice(0,11);
  if(t.length === 11){
    return `(${t.slice(0,2)}) ${t.slice(2,3)} ${t.slice(3,7)}-${t.slice(7)}`;
  }
  if(t.length === 10){
    return `(${t.slice(0,2)}) ${t.slice(2,6)}-${t.slice(6)}`;
  }
  return v;
}
function setVal(id,val){
  const el = document.getElementById(id);
  if(el) el.value = val;
}

/* ✅ EXTRAI + ABRE LAUDO AUTOMATICAMENTE */
function extrairEAbrir(){
  extrairRapidoOrdemCorrigido();
  abrirLaudo();
}

/* ✅ EXTRAÇÃO ROBUSTA (não quebra nome) */
function extrairRapidoOrdemCorrigido(){
  const raw = document.getElementById("entrada_rapida").value || "";
  const linhas = raw.split(/\r?\n/).map(l => l.trim()).filter(Boolean);

  const l1 = linhas[0] || "";
  let nome = "";
  let exame = "";

  const match = l1.match(/(\d{1,6}\/\d{4})\s*$/);
  if(match){
    exame = match[1];
    nome = l1.replace(match[1],"").trim();
  }else{
    const parts = l1.split(/\s+/);
    exame = parts.pop() || "";
    nome = parts.join(" ");
  }

  const dataColeta = maskDate(linhas[1] || "");
  const nasc = maskDate(linhas[2] || "");
  const sus = onlyDigits(linhas[3] || "");
  const tel = maskPhone(linhas[4] || "");

  let rua="", bairro="", cidade="", cep="";
  let resp="";

  for(let i=5;i<linhas.length;i++){
    const line = linhas[i];

    if(/^rua\s*:/i.test(line)) rua = line.replace(/^rua\s*:\s*/i,"");
    else if(/^bairro\s*:/i.test(line)) bairro = line.replace(/^bairro\s*:\s*/i,"");
    else if(/^cidade\s*:/i.test(line)) cidade = line.replace(/^cidade\s*:\s*/i,"");
    else if(/^cep\s*:/i.test(line)) cep = line.replace(/^cep\s*:\s*/i,"");
    else {
      const t = up(line);
      if(t === "SNM") resp = "SHEINA N. MORAIS RAMALHO";
      if(t === "EAM") resp = "EDVÂNIA APARECIDA MENDES DE AZEVÊDO";
    }
  }

  setVal("paciente", up(nome));
  setVal("exame", up(exame));
  setVal("data_coleta", dataColeta);
  setVal("data_nascimento", nasc);
  setVal("cartao_sus", sus);
  setVal("telefone", up(tel));
  setVal("rua", up(rua));
  setVal("bairro", up(bairro));
  setVal("cidade", up(cidade));
  setVal("cep", maskCep(cep));
  if(resp) document.getElementById("responsavel").value = resp;
}

/* ✅ ABRIR LAUDO NA MESMA ABA (SEM POPOUT) */
function abrirLaudo(){
  const paciente = up(document.getElementById('paciente').value);
  const exame = up(document.getElementById('exame').value);
  const dataColeta = maskDate(document.getElementById('data_coleta').value);
  const dataNascimento = maskDate(document.getElementById('data_nascimento').value);
  const cartaoSus = onlyDigits(document.getElementById('cartao_sus').value);
  const telefone = up(document.getElementById('telefone').value);
  const rua = up(document.getElementById('rua').value);
  const bairro = up(document.getElementById('bairro').value);
  const cidade = up(document.getElementById('cidade').value);
  const cep = maskCep(document.getElementById('cep').value);
  const responsavel = up(document.getElementById('responsavel').value);
  const observacao = (document.getElementById('observacao').value || "").trim();

  const returnUrl = window.location.href;

  const params = new URLSearchParams({
    paciente, exame,
    data_coleta: dataColeta,
    data_nascimento: dataNascimento,
    cartao_sus: cartaoSus,
    telefone, rua, bairro, cidade, cep,
    responsavel,
    observacao,
    return: returnUrl
  });

  const laudoPath = "laudo.html";

  // ✅ MESMA ABA - evita popout
  window.location.href = laudoPath + "?" + params.toString();
}

/* ✅ REGISTRO SERVICE WORKER (PWA) */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./service-worker.js")
      .then(() => console.log("✅ PWA: Service Worker registrado (SISTEMA)!"))
      .catch((err) => console.log("❌ PWA erro (SISTEMA):", err));
  });
}
</script>

</body>
</html>
