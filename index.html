<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SI - SISTEMA DE INFORMAÇÃO</title>

<!-- ✅ PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0078d7">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>
  :root{
    --bgA:#baf2c7;
    --bgB:#0a2a47;
    --bgC:#061a2e;

    --glass:rgba(255,255,255,.10);
    --glass2:rgba(255,255,255,.06);
    --line:rgba(255,255,255,.18);

    --txt:#f5fbff;
    --muted:rgba(255,255,255,.78);

    --accent:#17e3a6;
    --accent2:#2196f3;

    --shadow:0 18px 40px rgba(0,0,0,.32);
    --shadow2:0 6px 24px rgba(0,0,0,.24);

    --r22:22px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}

  body{
    margin:0;
    font-family:"Segoe UI", Roboto, Arial, sans-serif;
    color:var(--txt);
    height:100vh;
    overflow:hidden; /* ✅ ZERO SCROLL */
    background: linear-gradient(90deg, var(--bgA) 0%, var(--bgB) 60%, var(--bgC) 100%);
    position:relative;
  }

  /* ✅ Watermark (marca d'água) discreta e no lugar certo */
  .watermark{
    position:fixed;
    top:88px;
    right:24px;
    width:min(46vw, 720px);
    height:calc(100vh - 110px);
    background:url("logo/logotipo.png") no-repeat right center;
    background-size:contain;
    opacity:.08;
    pointer-events:none;
    z-index:0;
    filter: saturate(.9) contrast(1.05);
  }

  .app{
    height:100vh;
    display:flex;
    flex-direction:column;
    position:relative;
    z-index:1;
  }

  /* ✅ Header */
  header{
    height:84px;
    padding:14px 22px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    border-bottom:1px solid rgba(255,255,255,.12);
    background: linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.00));
    backdrop-filter: blur(10px);
  }

  .brand{
    display:flex;
    align-items:center;
    gap:14px;
    min-width: 320px;
  }

  .brand img{
    width:170px;
    max-height:52px;
    height:auto;
    object-fit:contain;
    display:block;
    filter: drop-shadow(0 10px 16px rgba(0,0,0,.35));
  }

  .brand-info{
    display:flex;
    flex-direction:column;
    line-height:1.05;
  }

  .brand-info strong{
    font-size:14px;
    letter-spacing:.20em;
    text-transform:uppercase;
    font-weight:900;
    color: rgba(255,255,255,.92);
  }

  .brand-info span{
    margin-top:6px;
    font-size:12px;
    color:rgba(255,255,255,.68);
  }

  .hdr-right{
    display:flex;
    align-items:center;
    gap:10px;
  }

  .pill{
    padding:9px 12px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.18);
    font-size:12px;
    color:rgba(255,255,255,.86);
    letter-spacing:.04em;
    user-select:none;
    backdrop-filter: blur(10px);
    box-shadow: var(--shadow2);
  }

  /* ✅ Layout geral: 1 coluna */
  main{
    flex:1;
    min-height:0;
    display:grid;
    grid-template-columns: 1fr; /* ✅ sem lateral */
    gap:18px;
    padding:18px 22px 22px;
    height:calc(100vh - 84px);
    position:relative;
    z-index:1;
    max-width: 1060px;
    margin: 0 auto;
  }

  /* ✅ Painel */
  .panel{
    min-height:0;
    border-radius: var(--r22);
    border:1px solid var(--line);
    background: linear-gradient(180deg, var(--glass), var(--glass2));
    box-shadow: var(--shadow);
    overflow:hidden;
    display:flex;
    flex-direction:column;
  }

  .panel-h{
    padding:14px 16px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    border-bottom:1px solid rgba(255,255,255,.10);
  }

  .panel-h h1{
    margin:0;
    font-size:15px;
    text-transform:uppercase;
    letter-spacing:.16em;
    font-weight:900;
  }

  .panel-b{
    padding:16px;
    display:flex;
    flex-direction:column;
    gap:14px;
    min-height:0;
  }

  /* ✅ Digitação rápida */
  .quick{
    border-radius: var(--r22);
    border:1px solid rgba(255,255,255,.20);
    background: rgba(0,0,0,.20);
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.22);
    padding:16px;
  }

  .q-label{
    display:flex;
    align-items:center;
    gap:10px;
    font-size:12px;
    text-transform:uppercase;
    letter-spacing:.10em;
    color:rgba(255,255,255,.88);
    user-select:none;
    margin-bottom:10px;
  }

  .dot{
    width:11px;height:11px;border-radius:50%;
    background:linear-gradient(135deg, var(--accent), var(--accent2));
    box-shadow: 0 0 0 4px rgba(23,227,166,.14);
  }

  /* ✅ Guia fixa sempre visível */
  .guide{
    padding:10px 12px;
    border-radius:14px;
    border:1px dashed rgba(255,255,255,.20);
    background: rgba(255,255,255,.05);
    font-size:12px;
    color:rgba(255,255,255,.82);
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    user-select:none;
    margin-bottom:10px;
  }
  .guide code{
    font-family:Consolas, "Courier New", monospace;
    font-size:12px;
    padding:2px 8px;
    border-radius:10px;
    background: rgba(0,0,0,.26);
    border:1px solid rgba(255,255,255,.12);
  }

  textarea{
    width:100%;
    height:260px; /* ✅ conforto e ainda zero scroll */
    resize:none;
    border-radius: var(--r22);
    border:1px solid rgba(255,255,255,.18);
    padding:16px;
    outline:none;
    background: rgba(10,18,26,.65);
    color: rgba(255,255,255,.96);
    font-size: 15px;
    line-height:1.55;
    white-space:pre-wrap;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
  }

  textarea:focus{
    border-color: rgba(23,227,166,.72);
    box-shadow: 0 0 0 3px rgba(23,227,166,.18), inset 0 0 0 1px rgba(0,0,0,.25);
  }

  /* ✅ BOTÃO EVIDENTE */
  .btn{
    border:none;
    cursor:pointer;
    padding:16px 18px;
    border-radius: 18px;
    font-weight:900;
    letter-spacing:.04em;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    width:100%;
    background: linear-gradient(135deg, rgba(23,227,166,.96), rgba(33,150,243,.80));
    color:#06242a;
    box-shadow: 0 18px 34px rgba(0,0,0,.24);
    transition: transform .06s ease, filter .2s ease;
    margin-top:12px;
  }

  .btn:active{ transform:scale(.99) }

  .hint{
    margin-top:10px;
    font-size:12px;
    color: rgba(255,255,255,.78);
    line-height:1.5;
    user-select:none;
  }

  /* ✅ campos técnicos ocultos */
  .tech-hidden{ display:none !important; }

  @media (max-width: 980px){
    textarea{ height:220px; }
    .brand img{ width:160px; max-height:46px; }
  }
</style>
</head>

<body>
  <div class="watermark" aria-hidden="true"></div>

  <div class="app">
    <header>
      <div class="brand">
        <img src="logo/sesctopo.png" alt="SESC" />
        <div class="brand-info">
          <strong>SI - SISTEMA DE INFORMAÇÃO</strong>
          <span>Sistema Laboratorial • Laudos</span>
        </div>
      </div>

      <div class="hdr-right">
        <div class="pill">Modo Profissional</div>
        <div class="pill">Janela Central</div>
      </div>
    </header>

    <main>
      <section class="panel">
        <div class="panel-h">
          <h1>Digitação rápida</h1>
          <div class="pill">Extração automática</div>
        </div>

        <div class="panel-b">
          <div class="quick">
            <div class="q-label">
              <span class="dot"></span>
              Cole ou digite os dados no campo abaixo
            </div>

            <div class="guide">
              Ordem:
              <code>Data da Coleta</code> |
              <code>Data de Nascimento</code> |
              <code>Cartão SUS</code> |
              <code>Telefone</code> |
              <code>Rua</code>
            </div>

            <!-- ✅ Campo principal -->
            <textarea id="entrada_rapida" rows="11"></textarea>

            <!-- ✅ Botão bem visível -->
            <button class="btn" onclick="extrairEAbrir()">
              EXTRAIR AUTOMATICAMENTE E ABRIR LAUDO
            </button>

            <div class="hint">
              ✅ Última linha pode ser: <b>SNM</b> ou <b>EAM</b> (Responsável).<br>
              ✅ O nome não quebra: o exame é detectado por padrão <b>000156/2026</b>.
            </div>
          </div>

          <!-- ✅ Campos técnicos (existem mas invisíveis) -->
          <div class="tech-hidden">
            <input id="paciente" type="text"/>
            <input id="exame" type="text"/>
            <input id="data_coleta" type="text" maxlength="10"/>
            <input id="data_nascimento" type="text" maxlength="10"/>
            <input id="cartao_sus" type="text"/>
            <input id="telefone" type="text"/>
            <input id="rua" type="text"/>
            <input id="bairro" type="text"/>
            <input id="cidade" type="text"/>
            <input id="cep" type="text"/>

            <select id="responsavel">
              <option value="">Selecione...</option>
              <option value="SHEINA N. MORAIS RAMALHO">SHEINA N. MORAIS RAMALHO</option>
              <option value="EDVÂNIA APARECIDA MENDES DE AZEVÊDO">EDVÂNIA APARECIDA MENDES DE AZEVÊDO</option>
            </select>

            <input id="observacao" type="text"/>
          </div>
        </div>
      </section>
    </main>
  </div>

<script>
function onlyDigits(s){ return (s||"").replace(/\D/g,''); }
function up(v){ return (v||"").toUpperCase().trim(); }

function maskDate(v){
  let d = onlyDigits(v).slice(0,8);
  if(d.length >= 5) return d.replace(/(\d{2})(\d{2})(\d+)/,'$1/$2/$3');
  if(d.length >= 3) return d.replace(/(\d{2})(\d+)/,'$1/$2');
  return d;
}
function maskCep(v){
  let c = onlyDigits(v).slice(0,8);
  if(c.length > 5) return c.replace(/(\d{5})(\d+)/,'$1-$2');
  return c;
}
function maskPhone(v){
  let t = onlyDigits(v).slice(0,11);
  if(t.length === 11){
    return `(${t.slice(0,2)}) ${t.slice(2,3)} ${t.slice(3,7)}-${t.slice(7)}`;
  }
  if(t.length === 10){
    return `(${t.slice(0,2)}) ${t.slice(2,6)}-${t.slice(6)}`;
  }
  return v;
}
function setVal(id,val){
  const el = document.getElementById(id);
  if(el) el.value = val;
}

/* ✅ EXTRAI + ABRE LAUDO AUTOMATICAMENTE */
function extrairEAbrir(){
  extrairRapidoOrdemCorrigido();
  abrirLaudo();
}

/* ✅ EXTRAÇÃO ROBUSTA (não quebra nome) */
function extrairRapidoOrdemCorrigido(){
  const raw = document.getElementById("entrada_rapida").value || "";
  const linhas = raw.split(/\r?\n/).map(l => l.trim()).filter(Boolean);

  const l1 = linhas[0] || "";
  let nome = "", exame = "";

  const match = l1.match(/(\d{1,6}\/\d{4})\s*$/);
  if(match){
    exame = match[1];
    nome = l1.replace(match[1],"").trim();
  }else{
    const parts = l1.split(/\s+/);
    exame = parts.pop() || "";
    nome = parts.join(" ");
  }

  const dataColeta = maskDate(linhas[1] || "");
  const nasc = maskDate(linhas[2] || "");
  const sus = onlyDigits(linhas[3] || "");
  const tel = maskPhone(linhas[4] || "");

  let rua="", bairro="", cidade="", cep="", resp="";

  for(let i=5;i<linhas.length;i++){
    const line = linhas[i];

    if(/^rua\s*:/i.test(line)) rua = line.replace(/^rua\s*:\s*/i,"");
    else if(/^bairro\s*:/i.test(line)) bairro = line.replace(/^bairro\s*:\s*/i,"");
    else if(/^cidade\s*:/i.test(line)) cidade = line.replace(/^cidade\s*:\s*/i,"");
    else if(/^cep\s*:/i.test(line)) cep = line.replace(/^cep\s*:\s*/i,"");
    else {
      const t = up(line);
      if(t === "SNM") resp = "SHEINA N. MORAIS RAMALHO";
      if(t === "EAM") resp = "EDVÂNIA APARECIDA MENDES DE AZEVÊDO";
    }
  }

  setVal("paciente", up(nome));
  setVal("exame", up(exame));
  setVal("data_coleta", dataColeta);
  setVal("data_nascimento", nasc);
  setVal("cartao_sus", sus);
  setVal("telefone", up(tel));
  setVal("rua", up(rua));
  setVal("bairro", up(bairro));
  setVal("cidade", up(cidade));
  setVal("cep", maskCep(cep));
  if(resp) document.getElementById("responsavel").value = resp;
}

/* ✅ ABRIR LAUDO EM JANELA CENTRAL (compacta) */
function abrirLaudo(){
  const paciente = up(document.getElementById('paciente').value);
  const exame = up(document.getElementById('exame').value);
  const dataColeta = maskDate(document.getElementById('data_coleta').value);
  const dataNascimento = maskDate(document.getElementById('data_nascimento').value);
  const cartaoSus = onlyDigits(document.getElementById('cartao_sus').value);
  const telefone = up(document.getElementById('telefone').value);
  const rua = up(document.getElementById('rua').value);
  const bairro = up(document.getElementById('bairro').value);
  const cidade = up(document.getElementById('cidade').value);
  const cep = maskCep(document.getElementById('cep').value);
  const responsavel = up(document.getElementById('responsavel').value);
  const observacao = (document.getElementById('observacao').value || "").trim();

  const returnUrl = window.location.href;

  const params = new URLSearchParams({
    paciente, exame,
    data_coleta: dataColeta,
    data_nascimento: dataNascimento,
    cartao_sus: cartaoSus,
    telefone, rua, bairro, cidade, cep,
    responsavel,
    observacao,
    return: returnUrl
  });

  const laudoPath = "laudo.html";
  const url = laudoPath + "?" + params.toString();

  /* ✅ janela no meio e menor */
  const w = 900;
  const h = 680;

  const left = Math.max(0, (window.screen.width - w) / 2);
  const top = Math.max(0, (window.screen.height - h) / 2);

  const specs =
    `width=${w},height=${h},left=${left},top=${top},` +
    `resizable=yes,scrollbars=yes,status=no,toolbar=no,menubar=no,location=no`;

  const popup = window.open(url, "LAUDO_POPUP", specs);

  if(!popup){
    window.location.href = url; // fallback se popup bloqueado
    return;
  }

  popup.focus();
}

/* ✅ REGISTRO SERVICE WORKER (PWA) */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./service-worker.js")
      .then(() => console.log("✅ PWA: Service Worker registrado (SISTEMA)!"))
      .catch((err) => console.log("❌ PWA erro (SISTEMA):", err));
  });
}
</script>

</body>
</html>
